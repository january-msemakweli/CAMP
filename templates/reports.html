{% extends "base.html" %}

{% block content %}
<div class="container-fluid p-4">
    <!-- Reports Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 fw-bold mb-3" style="color: var(--primary-color);">
                <i class="fas fa-file-pdf me-2" style="color: var(--gold-color);"></i>Generate Reports
            </h1>
            <p class="text-muted">Generate comprehensive PDF reports for medical camp activities</p>
        </div>
    </div>

    <!-- Report Configuration Form -->
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card border-0 shadow">
                <div class="card-header py-3" style="background-color: var(--primary-color); color: white;">
                    <h5 class="mb-0">
                        <i class="fas fa-cog me-2" style="color: var(--gold-color);"></i>Report Configuration
                    </h5>
                </div>
                <div class="card-body p-4">
                    <form id="reportForm" action="{{ url_for('generate_report') }}" method="POST" target="_blank">
                        
                        <!-- Step 1: Select Programme -->
                        <div class="mb-4">
                            <label for="programme" class="form-label fw-bold">
                                <i class="fas fa-project-diagram me-2" style="color: var(--accent-color);"></i>
                                1. SELECT PROGRAMME
                            </label>
                            <select class="form-select" id="programme" name="project_id" required>
                                <option value="">Choose a programme...</option>
                                {% for project in projects %}
                                <option value="{{ project.id }}">{{ project.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Step 2: Select Report Type (Hidden until programme selected) -->
                        <div class="mb-4" id="reportTypeSection" style="display: none;">
                            <label for="reportType" class="form-label fw-bold">
                                <i class="fas fa-chart-bar me-2" style="color: var(--accent-color);"></i>
                                2. SELECT REPORT TYPE
                            </label>
                            <select class="form-select" id="reportType" name="report_type" required>
                                <option value="">Choose a report type...</option>
                            </select>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Available report types for the selected programme
                            </div>
                        </div>

                        <!-- Step 3: Select Doctor's Name (Hidden until report type selected, only for doctor reports) -->
                        <div class="mb-4" id="doctorSection" style="display: none;">
                            <label for="doctor" class="form-label fw-bold">
                                <i class="fas fa-user-md me-2" style="color: var(--accent-color);"></i>
                                3. CHOOSE DOCTOR'S NAME
                            </label>
                            <select class="form-select" id="doctor" name="doctor" required>
                                <option value="">Choose a doctor...</option>
                            </select>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Loading doctors from the selected programme...
                            </div>
                        </div>

                        <!-- Step 4: Choose Date Range (Hidden until previous selections made) -->
                        <div class="mb-4" id="dateSection" style="display: none;">
                            <label class="form-label fw-bold">
                                <i class="fas fa-calendar-alt me-2" style="color: var(--accent-color);"></i>
                                4. CHOOSE DATE RANGE
                            </label>
                            
                            <!-- Quick Date Options -->
                            <div class="mb-3">
                                <div class="btn-group w-100" role="group" aria-label="Quick date selection">
                                    <input type="radio" class="btn-check" name="dateType" id="today" value="today" checked>
                                    <label class="btn btn-outline-primary" for="today">
                                        <i class="fas fa-clock me-1"></i>Today
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="dateType" id="custom" value="custom">
                                    <label class="btn btn-outline-primary" for="custom">
                                        <i class="fas fa-calendar-week me-1"></i>Custom Range
                                    </label>
                                </div>
                            </div>

                            <!-- Custom Date Range (Hidden by default) -->
                            <div id="customDateRange" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="startDate" class="form-label">Start Date</label>
                                        <input type="date" class="form-control" id="startDate" name="startDate">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="endDate" class="form-label">End Date</label>
                                        <input type="date" class="form-control" id="endDate" name="endDate">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 5: Generate Report Button (Hidden until all selections made) -->
                        <div class="mb-3" id="generateSection" style="display: none;">
                            <button type="submit" class="btn btn-success btn-lg w-100">
                                <i class="fas fa-download me-2"></i>Generate PDF Report
                            </button>
                            <div class="form-text text-center mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                The report will open in a new tab
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Preview Section -->
    <div class="row mt-4" id="previewSection" style="display: none;">
        <div class="col-12">
            <div class="card border-0 shadow">
                <div class="card-header py-3" style="background-color: var(--secondary-color); color: white;">
                    <h5 class="mb-0">
                        <i class="fas fa-eye me-2" style="color: var(--gold-color);"></i>Report Preview
                    </h5>
                </div>
                <div class="card-body">
                    <div id="reportStats" class="row text-center">
                        <div class="col-md-4">
                            <div class="bg-light p-3 rounded">
                                <i class="fas fa-users fa-2x text-primary mb-2"></i>
                                <h4 id="totalPatients" class="mb-1">-</h4>
                                <small class="text-muted">Total Patients</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="bg-light p-3 rounded">
                                <i class="fas fa-calendar fa-2x text-success mb-2"></i>
                                <h4 id="dateRange" class="mb-1">-</h4>
                                <small class="text-muted">Date Range</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="bg-light p-3 rounded">
                                <i class="fas fa-user-md fa-2x text-info mb-2"></i>
                                <h4 id="selectedDoctor" class="mb-1">-</h4>
                                <small class="text-muted">Doctor</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const programmeSelect = document.getElementById('programme');
    const reportTypeSelect = document.getElementById('reportType');
    const reportTypeSection = document.getElementById('reportTypeSection');
    const doctorSelect = document.getElementById('doctor');
    const doctorSection = document.getElementById('doctorSection');
    const dateSection = document.getElementById('dateSection');
    const generateSection = document.getElementById('generateSection');
    const previewSection = document.getElementById('previewSection');
    const customDateRange = document.getElementById('customDateRange');
    
    // Date type radio buttons
    const todayRadio = document.getElementById('today');
    const customRadio = document.getElementById('custom');
    
    // Set today's date as default for custom range
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('startDate').value = today;
    document.getElementById('endDate').value = today;
    
    // Handle programme selection
    programmeSelect.addEventListener('change', function() {
        if (this.value) {
            loadReportTypes(this.value);
            reportTypeSection.style.display = 'block';
            
            // Hide subsequent sections
            doctorSection.style.display = 'none';
            dateSection.style.display = 'none';
            generateSection.style.display = 'none';
            previewSection.style.display = 'none';
        } else {
            reportTypeSection.style.display = 'none';
            doctorSection.style.display = 'none';
            dateSection.style.display = 'none';
            generateSection.style.display = 'none';
            previewSection.style.display = 'none';
        }
    });
    
    // Handle report type selection
    reportTypeSelect.addEventListener('change', function() {
        if (this.value) {
            if (this.value === 'doctor') {
                // For doctor reports, show doctor selection
                loadDoctors(programmeSelect.value);
                doctorSelect.required = true;
                doctorSection.style.display = 'block';
                dateSection.style.display = 'none';
                generateSection.style.display = 'none';
                previewSection.style.display = 'none';
            } else {
                // For form reports, skip doctor selection and go to date
                doctorSelect.required = false;
                doctorSection.style.display = 'none';
                dateSection.style.display = 'block';
                generateSection.style.display = 'block';
                updatePreview();
            }
        } else {
            doctorSection.style.display = 'none';
            dateSection.style.display = 'none';
            generateSection.style.display = 'none';
            previewSection.style.display = 'none';
        }
    });
    
    // Handle doctor selection (only for doctor reports)
    doctorSelect.addEventListener('change', function() {
        if (this.value && reportTypeSelect.value === 'doctor') {
            dateSection.style.display = 'block';
            generateSection.style.display = 'block';
            updatePreview();
        } else {
            dateSection.style.display = 'none';
            generateSection.style.display = 'none';
            previewSection.style.display = 'none';
        }
    });
    
    // Handle date type change
    [todayRadio, customRadio].forEach(radio => {
        radio.addEventListener('change', function() {
            if (customRadio.checked) {
                customDateRange.style.display = 'block';
            } else {
                customDateRange.style.display = 'none';
            }
            updatePreview();
        });
    });
    
    // Handle custom date changes
    ['startDate', 'endDate'].forEach(id => {
        document.getElementById(id).addEventListener('change', updatePreview);
    });
    
    function loadReportTypes(programmeId) {
        reportTypeSelect.innerHTML = '<option value="">Loading report types...</option>';
        
        fetch(`/api/report_types/${programmeId}`)
            .then(response => response.json())
            .then(data => {
                reportTypeSelect.innerHTML = '<option value="">Choose a report type...</option>';
                if (data.report_types && data.report_types.length > 0) {
                    data.report_types.forEach(reportType => {
                        const option = document.createElement('option');
                        option.value = reportType.value;
                        option.textContent = reportType.label;
                        reportTypeSelect.appendChild(option);
                    });
                } else {
                    reportTypeSelect.innerHTML = '<option value="">No report types available</option>';
                }
            })
            .catch(error => {
                console.error('Error loading report types:', error);
                reportTypeSelect.innerHTML = '<option value="">Error loading report types</option>';
            });
    }

    function loadDoctors(programmeId) {
        doctorSelect.innerHTML = '<option value="">Loading doctors...</option>';
        
        fetch(`/api/doctors/${programmeId}`)
            .then(response => response.json())
            .then(data => {
                doctorSelect.innerHTML = '<option value="">Choose a doctor...</option>';
                if (data.doctors && data.doctors.length > 0) {
                    data.doctors.forEach(doctor => {
                        const option = document.createElement('option');
                        option.value = doctor;
                        option.textContent = doctor;
                        doctorSelect.appendChild(option);
                    });
                } else {
                    doctorSelect.innerHTML = '<option value="">No doctors found</option>';
                }
            })
            .catch(error => {
                console.error('Error loading doctors:', error);
                doctorSelect.innerHTML = '<option value="">Error loading doctors</option>';
            });
    }
    
    function updatePreview() {
        if (!programmeSelect.value || !reportTypeSelect.value) return;
        
        // For doctor reports, also require doctor selection
        if (reportTypeSelect.value === 'doctor' && !doctorSelect.value) return;
        
        const formData = new FormData();
        formData.append('project_id', programmeSelect.value);
        formData.append('report_type', reportTypeSelect.value);
        formData.append('dateType', document.querySelector('input[name="dateType"]:checked').value);
        
        // Only append doctor for doctor reports
        if (reportTypeSelect.value === 'doctor') {
            formData.append('doctor', doctorSelect.value);
        }
        
        if (customRadio.checked) {
            formData.append('startDate', document.getElementById('startDate').value);
            formData.append('endDate', document.getElementById('endDate').value);
        }
        
        fetch('/api/report_preview', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalPatients').textContent = data.totalPatients || 0;
            
            // Update display based on report type
            if (reportTypeSelect.value === 'doctor') {
                document.getElementById('selectedDoctor').textContent = doctorSelect.options[doctorSelect.selectedIndex].text;
            } else {
                document.getElementById('selectedDoctor').textContent = reportTypeSelect.options[reportTypeSelect.selectedIndex].text;
            }
            
            let dateRangeText = 'Today';
            if (customRadio.checked) {
                const start = document.getElementById('startDate').value;
                const end = document.getElementById('endDate').value;
                if (start === end) {
                    dateRangeText = new Date(start).toLocaleDateString();
                } else {
                    dateRangeText = `${new Date(start).toLocaleDateString()} - ${new Date(end).toLocaleDateString()}`;
                }
            }
            document.getElementById('dateRange').textContent = dateRangeText;
            
            previewSection.style.display = 'block';
        })
        .catch(error => {
            console.error('Error updating preview:', error);
        });
    }
});
</script>
{% endblock %} 