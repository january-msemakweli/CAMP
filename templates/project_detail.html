{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Programme Header -->
    <div class="page-header mb-4">
        <div class="row align-items-center">
            <div class="col">
                <h2 class="mb-1"><i class="fas fa-folder-open me-2"></i>{{ project.name }}</h2>
                <p class="text-muted mb-0">Programme created on: {{ project.created_at | to_eat }}</p>
            </div>
            <div class="col-auto">
                {% if current_user.is_admin %}
                <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteProjectModal">
                    <i class="fas fa-trash me-1"></i> Delete Programme
                </button>
                {% endif %}
        </div>
    </div>
</div>

    <!-- Forms Section -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-list-alt me-2"></i>Forms in this Programme</h5>
                {% if current_user.is_admin %}
                        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#createFormModal">
                            <i class="fas fa-plus me-1"></i> Create New Form
                </button>
                {% endif %}
            </div>
            <div class="card-body">
                {% if forms %}
                        <div class="list-group list-group-flush">
                                {% for form in forms %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <a href="{{ url_for('view_form', form_id=form.id) }}" class="fw-bold">{{ form.title }}</a>
                                        <br>
                                        <small class="text-muted">Fields: {{ form.fields | length }} | Created: {{ form.created_at | to_eat }}</small>
                                            </div>
                                    <div class="form-actions">
                                        <a href="{{ url_for('view_form', form_id=form.id) }}" class="btn btn-sm btn-outline-primary me-1">
                                            <i class="fas fa-eye"></i> View / Submit
                                        </a>
                                        {% if current_user.is_admin %}
                                            <button type="button" class="btn btn-sm btn-outline-warning me-1" 
                                                    onclick="openEditFormModal('{{ form.id }}')">
                                                <i class="fas fa-edit"></i> Edit
                                        </button>
                                            <form method="POST" action="{{ url_for('delete_form', form_id=form.id) }}" class="d-inline" 
                                                  onsubmit="return confirm('Are you sure you want to archive this form? It will be hidden from the UI but all data will be preserved.');">
                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    <i class="fas fa-archive"></i> Archive
                                        </button>
                                            </form>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-center text-muted">No forms have been created for this programme yet.</p>
                        {% if current_user.is_admin %}
                        <div class="text-center">
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createFormModal">
                                <i class="fas fa-plus me-1"></i> Create First Form
                            </button>
                        </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- NEW: User Access Control Section (Admin Only) -->
        {% if current_user.is_admin %}
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-users-cog me-2"></i>Programme User Access</h5>
                </div>
                <div class="card-body">
                    <!-- Grant Access Form -->
                    <h6 class="mb-3">Grant Access</h6>
                    <form method="POST" action="{{ url_for('grant_project_access', project_id=project.id) }}" class="mb-4">
                        <div class="input-group">
                            <select class="form-select" name="user_id" required aria-label="Select user to grant access">
                                <option value="">Select User to Grant Access</option>
                                {% for user in users %}
                                    {% if user.is_approved and user.id != current_user.id and user.id not in project_access|map(attribute='user_id')|list %}
                                        <option value="{{ user.id }}">{{ user.username }}</option>
                                    {% endif %}
                                {% else %}
                                    <option value="" disabled>No eligible users found</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-plus me-1"></i> Grant
                            </button>
                        </div>
                        <div class="form-text">
                            {% if users|selectattr('is_approved')|selectattr('id', 'ne', current_user.id)|list|length > 0 and project_access|map(attribute='user_id')|list|length > 0 %}
                                Only showing users who don't already have access.
                            {% elif users|selectattr('is_approved')|selectattr('id', 'ne', current_user.id)|list|length == 0 %}
                                No eligible users available.
                            {% endif %}
                        </div>
                    </form>

                    <hr>
                    
                    <!-- Users With Access List -->
                    <h6 class="mb-3">Users With Access</h6>
                    {% if project_access %}
                        <ul class="list-group list-group-flush">
                            {% for access in project_access %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>
                                        <i class="fas fa-user me-2 text-muted"></i>
                                        {{ access.users.username if access.users else 'Unknown User' }}
                                        <small class="text-muted ms-2">(Granted: {{ access.created_at | to_eat }})</small>
                                    </span>
                                    <form method="POST" action="{{ url_for('revoke_project_access', project_id=project.id, access_id=access.id) }}" 
                                          onsubmit="return confirm('Are you sure you want to revoke access for this user?')">
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            <i class="fas fa-user-times"></i> Revoke
                                        </button>
                                    </form>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-center text-muted">No users have been granted access to this programme yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
        {% endif %}
        <!-- End User Access Control Section -->
        
</div>

    <!-- Modals -->
{% if current_user.is_admin %}
    <!-- Create Form Modal -->
    <div class="modal fade" id="createFormModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                    <h5 class="modal-title">Create New Form for {{ project.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" title="Close"></button>
            </div>
                                        <form method="POST" action="{{ url_for('create_form', project_id=project.id) }}" id="createForm" onsubmit="debugFormSubmission(this)">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="formTitle" class="form-label">Form Title</label>
                        <input type="text" class="form-control" id="formTitle" name="title" required placeholder="Form title">
                    </div>
                        <hr>
                        <h6>Form Fields</h6>
                        <div id="formFieldsContainer">
                            <!-- Initial field row -->
                            <div class="row form-field-row mb-3 align-items-center">
                                <div class="col-md-4">
                                    <label class="form-label">Field Label</label>
                                    <input type="text" class="form-control form-control-sm" name="field_labels[]" required placeholder="Field label" title="Field label">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Field Type</label>
                                    <select class="form-select form-select-sm field-type" name="field_types[]" title="Field type">
                                        <option value="text">Text</option>
                                        <option value="number">Number</option>
                                        <option value="date">Date</option>
                                        <option value="dropdown">Dropdown</option>
                                        <option value="radio">Radio Buttons</option>
                                        <option value="checkbox">Checkboxes</option>
                                    </select>
                                </div>
                                <div class="col-md-4 options-container" style="display: none;">
                                    <label class="form-label">Options (comma-separated)</label>
                                    <input type="text" class="form-control form-control-sm" name="field_options[]" placeholder="Comma-separated options" title="Options">
                                    <input type="hidden" name="location_field_identifier[]" value=""> <!-- Hidden input for location type -->
                                    <div class="form-check mt-2 allow-other-check" style="display:none;">
                                        <input class="form-check-input" type="checkbox" name="allow_other[]" value="0" title="Allow Other (specify)">
                                        <label class="form-check-label">Allow Other (specify)</label>
                                    </div>
                                </div>
                                <div class="col-md-12 mt-2 conditional-container">
                                    <div class="card card-body bg-light">
                                        <h6 class="mb-2"><i class="fas fa-code-branch me-1"></i>Conditional Display</h6>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input conditional-checkbox" type="checkbox" name="is_conditional[]" value="0" title="Enable conditional display">
                                            <label class="form-check-label">Show this field only when another field meets a condition</label>
                                        </div>
                                        <div class="conditional-settings" style="display: none;">
                                            <div class="mb-2">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <label class="form-label small mb-0">Conditions</label>
                                                    <div class="d-flex align-items-center gap-2">
                                                        <small class="text-muted">Logic:</small>
                                                        <select class="form-select form-select-sm w-auto condition-logic-select" name="condition_logic[]" title="How multiple conditions should be evaluated">
                                                            <option value="OR">Any condition (OR)</option>
                                                            <option value="AND">All conditions (AND)</option>
                                                        </select>
                                                        <button type="button" class="btn btn-sm btn-outline-primary add-condition-btn" title="Add another condition">
                                                            <i class="fas fa-plus"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="conditions-container">
                                                    <div class="condition-rule mb-2">
                                                        <div class="row g-2 align-items-end">
                                                            <div class="col-md-4">
                                                                <label class="form-label small">Dependent Field</label>
                                                                <select class="form-select form-select-sm dependent-field-select" name="condition_field[]">
                                                                    <option value="">Select a field...</option>
                                                                    <!-- Options will be populated by JavaScript -->
                                                                </select>
                                                            </div>
                                                            <div class="col-md-3">
                                                                <label class="form-label small">Condition</label>
                                                                <select class="form-select form-select-sm" name="condition_operator[]">
                                                                    <option value="equals">Equals</option>
                                                                    <option value="not_equals">Not Equals</option>
                                                                    <option value="is_empty">Is Empty</option>
                                                                    <option value="is_not_empty">Is Not Empty</option>
                                                                    <option value="starts_with">Starts With</option>
                                                                    <option value="ends_with">Ends With</option>
                                                                    <option value="contains">Contains</option>
                                                                    <option value="not_contains">Does Not Contain</option>
                                                                    <option value="in_list">In List (comma-separated)</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <label class="form-label small">Value</label>
                                                                <input type="text" class="form-control form-control-sm condition-value-input" name="condition_value[]" placeholder="Expected value">
                                                            </div>
                                                            <div class="col-md-1">
                                                                <button type="button" class="btn btn-sm btn-outline-danger remove-condition-btn" title="Remove this condition" style="display: none;">
                                                                    <i class="fas fa-times"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <small class="form-text text-muted condition-help-text" style="display: none;">Enter comma-separated values (e.g., yes,not sure,maybe). Field will show if ANY user selection matches ANY trigger value.</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-1 text-end">
                                     <label class="form-label">&nbsp;</label><br/>
                                    <button type="button" class="btn btn-sm btn-danger remove-field-btn" style="display: none;">X</button>
                                </div>
                                <div class="col-md-12 mt-2">
                                    <div class="form-check">
                                        <input class="form-check-input required-checkbox" type="checkbox" value="0" name="field_required[]" title="Required field checkbox">
                                        <label class="form-check-label">
                                            Required
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" id="addFieldBtn" class="btn btn-sm btn-outline-success mt-2">
                            <i class="fas fa-plus me-1"></i> Add Another Field
                            </button>
                        {# --- Add Address Fields Button --- #}
                        <button type="button" id="createAddAddressFieldsBtn" class="btn btn-sm btn-outline-secondary mt-2 ms-2">
                            <i class="fas fa-map-marker-alt me-1"></i> Add Standard Address Fields
                            </button>
                        {# --------------------------------- #}
                        </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Create Form</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Form Modal -->
    <div class="modal fade" id="editFormModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Form</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" title="Close"></button>
                </div>
                <form method="POST" action="" id="editForm" onsubmit="debugFormSubmission(this)">
                    <div class="modal-body">
                        <input type="hidden" id="editFormId" value="">
                        <div class="mb-3">
                            <label for="editFormTitle" class="form-label">Form Title</label>
                            <input type="text" class="form-control" id="editFormTitle" name="title" required placeholder="Form title">
                        </div>
                        <hr>
                        <h6>Form Fields</h6>
                        <div id="editFormFieldsContainer">
                            <!-- Fields will be loaded here by JavaScript -->
                        </div>
                        <button type="button" id="editAddFieldBtn" class="btn btn-sm btn-outline-success mt-2">
                            <i class="fas fa-plus me-1"></i> Add Another Field
                        </button>
                        {# --- Add Address Fields Button (for Edit Modal) --- #}
                        <button type="button" id="editAddAddressFieldsBtn" class="btn btn-sm btn-outline-secondary mt-2 ms-2">
                            <i class="fas fa-map-marker-alt me-1"></i> Add Standard Address Fields
                        </button>
                        {# ---------------------------------------------- #}
                </div>
                <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
            </div>
        </div>
    </div>
</div>

    <!-- Delete Programme Modal -->
    <div class="modal fade" id="deleteProjectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Confirm Programme Deletion</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" title="Close"></button>
            </div>
            <div class="modal-body">
                    <p><strong>Warning!</strong> Deleting this programme (<strong>{{ project.name }}</strong>) will permanently remove:</p>
                    <ul>
                        <li>All forms associated with this programme.</li>
                        <li>Patient data associated with this programme will be disassociated (project_id set to NULL).</li>
                    </ul>
                    <p class="text-danger fw-bold">This action cannot be undone. Are you absolutely sure?</p>
            </div>
            <div class="modal-footer">
                    <form method="POST" action="{{ url_for('delete_project', project_id=project.id) }}">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Yes, Delete Programme Permanently</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block scripts %}
<script>
// Shared function to add a field row to a container
function addFieldRow(containerId, allowRemove) {
    const container = document.getElementById(containerId);
    // const template = document.querySelector('.form-field-row'); // Use the one in create form as template
    // Define template string directly
    const fieldRowTemplate = `
        <div class="row form-field-row mb-3 align-items-center">
                <div class="col-md-4">
                <label class="form-label">Field Label</label>
                <input type="text" class="form-control form-control-sm" name="field_labels[]" required placeholder="Field label" title="Field label">
                </div>
            <div class="col-md-3">
                <label class="form-label">Field Type</label>
                <select class="form-select form-select-sm field-type" name="field_types[]" title="Field type">
                    <option value="text">Text</option>
                    <option value="number">Number</option>
                    <option value="date">Date</option>
                    <option value="dropdown">Dropdown</option>
                    <option value="radio">Radio Buttons</option>
                    <option value="checkbox">Checkboxes</option>
                </select>
            </div>
            <div class="col-md-4 options-container" style="display: none;">
                <label class="form-label">Options (comma-separated)</label>
                <input type="text" class="form-control form-control-sm" name="field_options[]" placeholder="Comma-separated options" title="Options">
                <input type="hidden" name="location_field_identifier[]" value=""> 
                <div class="form-check mt-2 allow-other-check" style="display:none;">
                    <input class="form-check-input" type="checkbox" name="allow_other[]" value="0" title="Allow Other (specify)">
                    <label class="form-check-label">Allow Other (specify)</label>
                </div>
            </div>
            <div class="col-md-12 mt-2 conditional-container">
                <div class="card card-body bg-light">
                    <h6 class="mb-2"><i class="fas fa-code-branch me-1"></i>Conditional Display</h6>
                    <div class="form-check mb-2">
                        <input class="form-check-input conditional-checkbox" type="checkbox" name="is_conditional[]" value="" title="Enable conditional display">
                        <label class="form-check-label">Show this field only when another field meets a condition</label>
                    </div>
                    <div class="conditional-settings" style="display: none;">
                        <div class="mb-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label small mb-0">Conditions</label>
                                <div class="d-flex align-items-center gap-2">
                                    <small class="text-muted">Logic:</small>
                                    <select class="form-select form-select-sm w-auto condition-logic-select" name="condition_logic[]" title="How multiple conditions should be evaluated">
                                        <option value="OR">Any condition (OR)</option>
                                        <option value="AND">All conditions (AND)</option>
                                    </select>
                                    <button type="button" class="btn btn-sm btn-outline-primary add-condition-btn" title="Add another condition">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="conditions-container">
                                <div class="condition-rule mb-2">
                                    <div class="row g-2 align-items-end">
                                        <div class="col-md-4">
                                            <label class="form-label small">Dependent Field</label>
                                            <select class="form-select form-select-sm dependent-field-select" name="condition_field[]" title="Select dependent field">
                                                <option value="">Select a field...</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label small">Condition</label>
                                            <select class="form-select form-select-sm" name="condition_operator[]" title="Select condition operator">
                                                <option value="equals">Equals</option>
                                                <option value="not_equals">Not Equals</option>
                                                <option value="is_empty">Is Empty</option>
                                                <option value="is_not_empty">Is Not Empty</option>
                                                <option value="starts_with">Starts With</option>
                                                <option value="ends_with">Ends With</option>
                                                <option value="contains">Contains</option>
                                                <option value="not_contains">Does Not Contain</option>
                                                <option value="in_list">In List (comma-separated)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small">Value</label>
                                            <input type="text" class="form-control form-control-sm condition-value-input" name="condition_value[]" placeholder="Expected value" title="Expected value for condition">
                                        </div>
                                        <div class="col-md-1">
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-condition-btn" title="Remove this condition" style="display: none;">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <small class="form-text text-muted condition-help-text" style="display: none;">Enter comma-separated values (e.g., yes,not sure,maybe). Field will show if ANY user selection matches ANY trigger value.</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-1 text-end">
                 <label class="form-label">&nbsp;</label><br/>
                <button type="button" class="btn btn-sm btn-danger remove-field-btn" style="display: none;">X</button>
            </div>
            <div class="col-md-12 mt-2">
                <div class="form-check">
                    <input class="form-check-input required-checkbox" type="checkbox" value="0" name="field_required[]" title="Required field checkbox">
                    <label class="form-check-label">
                        Required
                    </label>
                </div>
            </div>
            </div>
        `;
    // Create element from template string
    const templateEl = document.createElement('div');
    templateEl.innerHTML = fieldRowTemplate.trim();
    const newRow = templateEl.firstChild;
    // const newRow = template.cloneNode(true);
    
    // Clear input values in the new row
    newRow.querySelectorAll('input, select').forEach(input => {
        if (input.type === 'checkbox' || input.type === 'radio') {
            input.checked = false;
        } else {
            input.value = '';
        }
        // Reset select to first option
        if (input.tagName === 'SELECT') {
            input.selectedIndex = 0;
        }
        // Reset options container visibility
        if (input.classList.contains('field-type')) {
            input.closest('.row').querySelector('.options-container').style.display = 'none';
        }
         // Reset hidden location identifier
        if (input.name === 'location_field_identifier[]') {
            input.value = '';
        }
    });

    // Show remove button if applicable
    const removeBtn = newRow.querySelector('.remove-field-btn');
    if (removeBtn) {
        removeBtn.style.display = allowRemove ? 'inline-block' : 'none';
        removeBtn.addEventListener('click', () => newRow.remove());
    }

    // Set unique IDs and values for the checkboxes and labels
    const rowCount = container.querySelectorAll('.form-field-row').length;
    const requiredCheckbox = newRow.querySelector('.required-checkbox');
    const requiredLabel = newRow.querySelector('.form-check-label');
    if (requiredCheckbox && requiredLabel) {
        const checkboxId = `field-required-${rowCount}`;
        requiredCheckbox.id = checkboxId;
        requiredCheckbox.value = rowCount;
        requiredLabel.setAttribute('for', checkboxId);
    }
    // Set value for allow_other checkbox
    const allowOtherCheckbox = newRow.querySelector('.allow-other-check input');
    if (allowOtherCheckbox) {
        allowOtherCheckbox.value = rowCount;
    }

    // Set value for conditional checkbox
    const conditionalCheckbox = newRow.querySelector('.conditional-checkbox');
    if (conditionalCheckbox) {
        conditionalCheckbox.value = rowCount;
    }

    // Show/hide allow-other-check for radio/checkbox fields on type change (for both modals)
    const typeSelect = newRow.querySelector('select[name="field_types[]"]');
    const optionsContainer = newRow.querySelector('.options-container');
    const allowOtherCheck = optionsContainer.querySelector('.allow-other-check');
    typeSelect.addEventListener('change', function() {
        const value = this.value;
        if (value === 'radio' || value === 'checkbox') {
            allowOtherCheck.style.display = 'block';
        } else {
            allowOtherCheck.style.display = 'none';
            allowOtherCheck.querySelector('input').checked = false;
        }
    });
    // If the default type is radio/checkbox, show allow-other-check
    if (typeSelect.value === 'radio' || typeSelect.value === 'checkbox') {
        allowOtherCheck.style.display = 'block';
    }

    container.appendChild(newRow);
}

// Add field functionality for Create Form Modal
document.getElementById('addFieldBtn')?.addEventListener('click', () => {
    addFieldRow('formFieldsContainer', true);
    // Make remove buttons visible for all rows except the first one after adding a new row
    const rows = document.querySelectorAll('#formFieldsContainer .form-field-row');
    rows.forEach((row, index) => {
        const removeBtn = row.querySelector('.remove-field-btn');
        if(removeBtn) removeBtn.style.display = index > 0 ? 'inline-block' : 'none';
    });
});

// Add field functionality for Edit Form Modal
document.getElementById('editAddFieldBtn')?.addEventListener('click', () => {
    addFieldRow('editFormFieldsContainer', true);
     // Ensure all remove buttons are shown
    document.querySelectorAll('#editFormFieldsContainer .remove-field-btn').forEach(btn => btn.style.display = 'inline-block');
});

// Handle field type change to show/hide options input
function handleFieldTypeChange(event) {
    const select = event.target;
    const row = select.closest('.row');
    const optionsContainer = row.querySelector('.options-container');
    const locationIdentifierInput = row.querySelector('input[name="location_field_identifier[]"]');
    const allowOtherCheck = optionsContainer.querySelector('.allow-other-check');
    const value = select.value;

    if (value === 'dropdown' || value === 'radio' || value === 'checkbox') {
        optionsContainer.style.display = 'block';
        locationIdentifierInput.value = '';
        if (value === 'radio' || value === 'checkbox') {
            allowOtherCheck.style.display = 'block';
        } else {
            allowOtherCheck.style.display = 'none';
            allowOtherCheck.querySelector('input').checked = false;
        }
    } else if (value.startsWith('location_')) {
        optionsContainer.style.display = 'none';
        optionsContainer.querySelector('input[name="field_options[]"]').value = '';
        locationIdentifierInput.value = value.split('_')[1];
        allowOtherCheck.style.display = 'none';
        allowOtherCheck.querySelector('input').checked = false;
    } else {
        optionsContainer.style.display = 'none';
        optionsContainer.querySelector('input[name="field_options[]"]').value = '';
        locationIdentifierInput.value = '';
        allowOtherCheck.style.display = 'none';
        allowOtherCheck.querySelector('input').checked = false;
    }
}

// Apply field type change handler to both create and edit forms dynamically
document.addEventListener('change', function(event) {
    if (event.target && event.target.classList.contains('field-type')) {
        handleFieldTypeChange(event);
    }
});

// Ensure initial remove buttons are hidden correctly for Create Form
document.querySelectorAll('#formFieldsContainer .form-field-row').forEach((row, index) => {
    const removeBtn = row.querySelector('.remove-field-btn');
    if(removeBtn) removeBtn.style.display = index > 0 ? 'inline-block' : 'none';
});

// --- Edit Form Modal Logic ---
const editFormModalElement = document.getElementById('editFormModal');
const editFormModal = editFormModalElement ? new bootstrap.Modal(editFormModalElement) : null;

function openEditFormModal(formId) {
    if (!editFormModal) return;
    console.log(`Opening edit modal for form: ${formId}`);

    const formElement = document.getElementById('editForm');
    const titleInput = document.getElementById('editFormTitle');
    const fieldsContainer = document.getElementById('editFormFieldsContainer');
    const formIdInput = document.getElementById('editFormId');

    // Reset previous state and set the correct form action URL
    formElement.action = `/form/${formId}/edit`;
    titleInput.value = '';
    fieldsContainer.innerHTML = '<p>Loading form fields...</p>';
    formIdInput.value = formId;

    // Correctly format the URL for the API endpoint
    const apiUrl = `/api/form/${formId}/details`;
    console.log(`Fetching form details from: ${apiUrl}`);

    // Fetch form details
    fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                 throw new Error(data.error);
            }
            console.log("Received form data:", data);
            titleInput.value = data.title;
            fieldsContainer.innerHTML = ''; // Clear loading message

            if (data.fields && data.fields.length > 0) {
                 data.fields.forEach((field, index) => {
                    addFieldRow('editFormFieldsContainer', true); // Add a new row structure
                    const lastRow = fieldsContainer.querySelector('.form-field-row:last-child');
                    
                    // Populate the new row with fetched data
                    lastRow.querySelector('input[name="field_labels[]"]').value = field.label;
                    const typeSelect = lastRow.querySelector('select[name="field_types[]"]');
                    const optionsInput = lastRow.querySelector('input[name="field_options[]"]');
                    const locationInput = lastRow.querySelector('input[name="location_field_identifier[]"]');
                    
                    let fieldTypeValue = field.type;
                    if (field.location_field_identifier) {
                        fieldTypeValue = `location_${field.location_field_identifier}`;
                        optionsInput.value = ''; // Clear options for location
                        locationInput.value = field.location_field_identifier;
                    } else {
                         optionsInput.value = field.options ? field.options.join(',') : '';
                         locationInput.value = '';
                    }
                    typeSelect.value = fieldTypeValue;

                    // Trigger change event to show/hide options container correctly
                    handleFieldTypeChange({ target: typeSelect });
                    
                     // Ensure remove buttons are visible for all rows in edit mode
                    lastRow.querySelector('.remove-field-btn').style.display = 'inline-block';

                    // Set required checkbox state
                    const requiredCheckbox = lastRow.querySelector('input[name="field_required[]"]');
                    if (requiredCheckbox) {
                        requiredCheckbox.checked = !!field.required;
                    }

                    // Set allow_other checkbox state
                    if (['dropdown', 'radio', 'checkbox'].includes(field.type)) {
                        const optionsContainer = lastRow.querySelector('.options-container');
                        const allowOtherCheck = optionsContainer.querySelector('.allow-other-check input');
                        optionsContainer.style.display = 'block';
                        optionsInput.value = field.options.join(', ');
                        if (field.type === 'radio' || field.type === 'checkbox') {
                            allowOtherCheck.checked = !!field.allow_other;
                            optionsContainer.querySelector('.allow-other-check').style.display = 'block';
                        } else {
                            allowOtherCheck.checked = false;
                            optionsContainer.querySelector('.allow-other-check').style.display = 'none';
                        }
                        // Handle location field identifiers
                        if (field.location_field_identifier) {
                            const locationInput = optionsContainer.querySelector('input[name="location_field_identifier[]"]');
                            locationInput.value = field.location_field_identifier;
                        }
                    }

                    // Set conditional field data for ALL field types (handle both old and new formats)
                    const conditionalContainer = lastRow.querySelector('.conditional-container');
                    const conditionalCheckbox = conditionalContainer.querySelector('.conditional-checkbox');
                    const conditionalSettings = conditionalContainer.querySelector('.conditional-settings');
                    
                    if (field.condition) {
                        console.log(`✅ Setting up conditional field for: ${field.label}`, field.condition);
                        conditionalCheckbox.checked = true;
                        conditionalCheckbox.value = index; // Set proper index value
                        conditionalSettings.style.display = 'block';
                        
                        // Handle new format with multiple conditions
                        if (field.condition.rules && Array.isArray(field.condition.rules)) {
                            // Multiple conditions format
                            const logicSelect = conditionalContainer.querySelector('.condition-logic-select');
                            logicSelect.value = field.condition.logic || 'OR';
                            
                            // Load each condition rule
                            field.condition.rules.forEach((rule, ruleIndex) => {
                                // Add additional condition rules if needed
                                if (ruleIndex > 0) {
                                    addConditionRule(lastRow);
                                }
                                
                                // Get the condition rule container (first one or newly added)
                                const conditionRules = conditionalContainer.querySelectorAll('.condition-rule');
                                const currentRule = conditionRules[ruleIndex];
                                
                                if (currentRule) {
                                    const dependentSelect = currentRule.querySelector('.dependent-field-select');
                                    const operatorSelect = currentRule.querySelector('select[name="condition_operator[]"]');
                                    const valueInput = currentRule.querySelector('input[name="condition_value[]"]');
                                    
                                    operatorSelect.value = rule.operator || 'equals';
                                    valueInput.value = rule.value || '';
                                    
                                    // Set dependent field after updating options
                                    setTimeout(() => {
                                        dependentSelect.value = rule.dependent_field;
                                    }, 100 + (ruleIndex * 50)); // Stagger the timeouts
                                }
                            });
                        }
                        // Handle backward compatibility - single condition format  
                        else if (field.condition.dependent_field) {
                            // Single condition format - load into first condition rule
                            const logicSelect = conditionalContainer.querySelector('.condition-logic-select');
                            logicSelect.value = 'OR'; // Default for single conditions
                            
                            const firstRule = conditionalContainer.querySelector('.condition-rule');
                            const dependentSelect = firstRule.querySelector('.dependent-field-select');
                            const operatorSelect = firstRule.querySelector('select[name="condition_operator[]"]');
                            const valueInput = firstRule.querySelector('input[name="condition_value[]"]');
                            
                            operatorSelect.value = field.condition.operator || 'equals';
                            valueInput.value = field.condition.value || '';
                            
                            setTimeout(() => {
                                dependentSelect.value = field.condition.dependent_field;
                            }, 100);
                        }
                        
                        // Don't update dependent field options yet - wait until all fields are loaded
                        updateRemoveButtons(lastRow);
                    } else {
                        console.log(`❌ NO condition for field: ${field.label} - unchecking conditional checkbox`);
                        conditionalCheckbox.checked = false;
                        conditionalCheckbox.value = index;
                        conditionalSettings.style.display = 'none';
                    }
                });

                // After ALL fields are loaded, update dependent field dropdowns for all conditional fields
                console.log('All fields loaded. Now updating dependent field dropdowns...');
                updateDependentFieldDropdowns('editFormFieldsContainer');
                
                // Set dependent field values after dropdowns are populated (with longer delay)
                setTimeout(() => {
                    console.log('Setting dependent field values...');
                    setConditionalFieldValues(data.fields);
                }, 300);
            } else {
                // If no fields, add one empty row
                 addFieldRow('editFormFieldsContainer', false); // Don't allow remove if it's the only one
                 fieldsContainer.querySelector('.remove-field-btn').style.display = 'none';
            }
            
            editFormModal.show();
        })
        .catch(error => {
            console.error('Error fetching or processing form details:', error);
            fieldsContainer.innerHTML = `<div class="alert alert-danger">Error loading form details: ${error.message}</div>`;
            editFormModal.show(); // Show modal even if error to display message
        });
}

// --- Logic for "Add Standard Address Fields" --- 
function addStandardAddressFields(containerSelector, buttonSelector) {
    const fieldsContainer = document.querySelector(containerSelector);
    const button = document.querySelector(buttonSelector);
    if (!fieldsContainer || !button) return;

    // Prevent adding multiple times
    if (button.dataset.added === 'true') {
         alert('Address fields have already been added.');
        return;
    }
    
    console.log('Adding standard address fields...');

    const addressFields = [
        { label: 'Region', identifier: 'region' },
        { label: 'District', identifier: 'district' },
        { label: 'Ward', identifier: 'ward' }
    ];

    addressFields.forEach(fieldInfo => {
        const newFieldRow = document.createElement('div');
        newFieldRow.className = 'row form-field-row mb-3 align-items-center address-field-row'; // Added specific class
        newFieldRow.innerHTML = `
            <div class="col-md-4">
                <label class="form-label">Field Label</label>
                <input type="text" class="form-control form-control-sm" name="field_labels[]" value="${fieldInfo.label}" readonly required>
            </div>
            <div class="col-md-3">
                <label class="form-label">Field Type</label>
                <input type="text" class="form-control form-control-sm" value="Location Dropdown" readonly>
                <input type="hidden" name="field_types[]" value="dropdown">
                <input type="hidden" name="location_field_identifier[]" value="${fieldInfo.identifier}">
                <input type="hidden" name="field_options[]" value=""> {# Ensure options array is present even if empty #}
            </div>
            <div class="col-md-4 options-container" style="display: none;">
                {# Options not applicable for location #}
            </div>
            <div class="col-md-1 text-end">
                <label class="form-label">&nbsp;</label><br/>
                <button type="button" class="btn btn-sm btn-danger remove-field-btn">X</button> {# Allow removal #}
            </div>
        `;
        fieldsContainer.appendChild(newFieldRow);
        // Attach event listener to the new remove button
        newFieldRow.querySelector('.remove-field-btn').addEventListener('click', function() {
             newFieldRow.remove();
             // Re-enable the add button if all address fields are removed?
             // Check if any .address-field-row remains. If not, enable.
             if (!fieldsContainer.querySelector('.address-field-row')) {
                button.disabled = false;
                 button.dataset.added = 'false';
             }
        });
    });

    // Disable the button after adding
    button.disabled = true;
    button.dataset.added = 'true';
    console.log('Address fields added.');
}

// Attach listener for Create Modal
const createAddBtn = document.getElementById('createAddAddressFieldsBtn');
if (createAddBtn) {
    createAddBtn.addEventListener('click', () => addStandardAddressFields('#formFieldsContainer', '#createAddAddressFieldsBtn'));
}

// Attach listener for Edit Modal
const editAddBtn = document.getElementById('editAddAddressFieldsBtn');
if (editAddBtn) {
    editAddBtn.addEventListener('click', () => addStandardAddressFields('#editFormFieldsContainer', '#editAddAddressFieldsBtn'));
}

// The openEditFormModal function above now handles all edit form functionality

document.addEventListener('DOMContentLoaded', function() {
    // Ensure allow-other-check is shown for radio/checkbox on initial field row in Create Form
    const createTypeSelect = document.querySelector('#formFieldsContainer .form-field-row select.field-type');
    const createOptionsContainer = document.querySelector('#formFieldsContainer .form-field-row .options-container');
    const createAllowOtherCheck = createOptionsContainer.querySelector('.allow-other-check');
    createTypeSelect.addEventListener('change', function() {
        if (this.value === 'radio' || this.value === 'checkbox') {
            createAllowOtherCheck.style.display = 'block';
        } else {
            createAllowOtherCheck.style.display = 'none';
            createAllowOtherCheck.querySelector('input').checked = false;
        }
    });
    // If the default type is radio/checkbox, show allow-other-check
    if (createTypeSelect.value === 'radio' || createTypeSelect.value === 'checkbox') {
        createAllowOtherCheck.style.display = 'block';
    }

    // Initialize conditional field functionality
    initializeConditionalFields();
});

// Conditional Fields Functionality
function initializeConditionalFields() {
    // Handle conditional checkbox changes
    document.addEventListener('change', function(event) {
        if (event.target && event.target.classList.contains('conditional-checkbox')) {
            const checkbox = event.target;
            const row = checkbox.closest('.form-field-row');
            const conditionalSettings = row.querySelector('.conditional-settings');
            
            if (checkbox.checked) {
                conditionalSettings.style.display = 'block';
                updateDependentFieldOptions(row);
                updateRemoveButtons(row);
            } else {
                conditionalSettings.style.display = 'none';
                // Clear all conditional settings
                clearAllConditions(row);
            }
        }
    });

    // Handle add condition button clicks
    document.addEventListener('click', function(event) {
        if (event.target && (event.target.classList.contains('add-condition-btn') || event.target.closest('.add-condition-btn'))) {
            const button = event.target.closest('.add-condition-btn');
            const row = button.closest('.form-field-row');
            addConditionRule(row);
        }
    });

    // Handle remove condition button clicks  
    document.addEventListener('click', function(event) {
        if (event.target && (event.target.classList.contains('remove-condition-btn') || event.target.closest('.remove-condition-btn'))) {
            const button = event.target.closest('.remove-condition-btn');
            const conditionRule = button.closest('.condition-rule');
            const row = button.closest('.form-field-row');
            conditionRule.remove();
            updateRemoveButtons(row);
        }
    });

    // Handle field label changes to update dependent field options
    document.addEventListener('input', function(event) {
        if (event.target && event.target.name === 'field_labels[]') {
            updateAllDependentFieldOptions();
        }
    });

    // Handle field removal to update dependent field options
    document.addEventListener('click', function(event) {
        if (event.target && event.target.classList.contains('remove-field-btn')) {
            setTimeout(updateAllDependentFieldOptions, 100); // Delay to allow DOM update
        }
    });
}

function updateDependentFieldOptions(targetRow) {
    // Update all dependent field selects in this row (there might be multiple now)
    const dependentSelects = targetRow.querySelectorAll('.dependent-field-select');
    dependentSelects.forEach(select => {
        populateDependentFieldOptions(select, targetRow);
    });
}

function updateAllDependentFieldOptions() {
    // Update all conditional field dropdowns
    document.querySelectorAll('.conditional-checkbox:checked').forEach(checkbox => {
        const row = checkbox.closest('.form-field-row');
        updateDependentFieldOptions(row);
    });
}

function updateDependentFieldDropdowns(containerSelector) {
    // Update all dependent field dropdowns in a specific container
    const container = document.querySelector(`#${containerSelector}`);
    if (!container) return;
    
    const allRows = Array.from(container.querySelectorAll('.form-field-row'));
    allRows.forEach(row => {
        updateDependentFieldOptions(row);
    });
}

// Helper functions for multiple conditions
function addConditionRule(targetRow) {
    const conditionsContainer = targetRow.querySelector('.conditions-container');
    const conditionRule = document.createElement('div');
    conditionRule.className = 'condition-rule mb-2';
    
    conditionRule.innerHTML = `
        <div class="row g-2 align-items-end">
            <div class="col-md-4">
                <label class="form-label small">Dependent Field</label>
                <select class="form-select form-select-sm dependent-field-select" name="condition_field[]">
                    <option value="">Select a field...</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small">Condition</label>
                <select class="form-select form-select-sm" name="condition_operator[]">
                    <option value="equals">Equals</option>
                    <option value="not_equals">Not Equals</option>
                    <option value="is_empty">Is Empty</option>
                    <option value="is_not_empty">Is Not Empty</option>
                    <option value="starts_with">Starts With</option>
                    <option value="ends_with">Ends With</option>
                    <option value="contains">Contains</option>
                    <option value="not_contains">Does Not Contain</option>
                    <option value="in_list">In List (comma-separated)</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label small">Value</label>
                <input type="text" class="form-control form-control-sm condition-value-input" name="condition_value[]" placeholder="Expected value">
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-sm btn-outline-danger remove-condition-btn" title="Remove this condition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    `;
    
    conditionsContainer.appendChild(conditionRule);
    
    // Update dependent field options for the new rule
    const newDependentSelect = conditionRule.querySelector('.dependent-field-select');
    populateDependentFieldOptions(newDependentSelect, targetRow);
    
    updateRemoveButtons(targetRow);
}

function updateRemoveButtons(targetRow) {
    const conditionRules = targetRow.querySelectorAll('.condition-rule');
    const removeButtons = targetRow.querySelectorAll('.remove-condition-btn');
    
    // Show remove buttons only if there are multiple conditions
    removeButtons.forEach(btn => {
        btn.style.display = conditionRules.length > 1 ? 'block' : 'none';
    });
}

function clearAllConditions(targetRow) {
    const conditionsContainer = targetRow.querySelector('.conditions-container');
    const conditionRules = conditionsContainer.querySelectorAll('.condition-rule');
    
    // Remove all but the first condition rule
    for (let i = 1; i < conditionRules.length; i++) {
        conditionRules[i].remove();
    }
    
    // Clear the first condition rule
    const firstRule = conditionsContainer.querySelector('.condition-rule');
    if (firstRule) {
        const dependentSelect = firstRule.querySelector('.dependent-field-select');
        const operatorSelect = firstRule.querySelector('select[name="condition_operator[]"]');
        const valueInput = firstRule.querySelector('input[name="condition_value[]"]');
        const logicSelect = targetRow.querySelector('.condition-logic-select');
        
        if (dependentSelect) dependentSelect.value = '';
        if (operatorSelect) operatorSelect.value = 'equals';
        if (valueInput) valueInput.value = '';
        if (logicSelect) logicSelect.value = 'OR';
    }
    
    updateRemoveButtons(targetRow);
}

function populateDependentFieldOptions(selectElement, targetRow) {
    if (!selectElement) return;

    // Get all field rows that come before this one
    const container = targetRow.closest('#formFieldsContainer, #editFormFieldsContainer');
    const allRows = Array.from(container.querySelectorAll('.form-field-row'));
    const targetIndex = allRows.indexOf(targetRow);
    const previousRows = allRows.slice(0, targetIndex);

    // Clear existing options except the first one
    selectElement.innerHTML = '<option value="">Select a field...</option>';

    // Add options for each previous field
    previousRows.forEach(row => {
        const labelInput = row.querySelector('input[name="field_labels[]"]');
        if (labelInput && labelInput.value.trim()) {
            const option = document.createElement('option');
            option.value = labelInput.value.trim();
            option.textContent = labelInput.value.trim();
            selectElement.appendChild(option);
        }
    });
}

// Handle dynamic placeholder and help text for conditional value inputs
function updateConditionalValuePlaceholder(operatorSelect) {
    const row = operatorSelect.closest('.row, .form-field-row');
    const valueInput = row.querySelector('.condition-value-input');
    const helpText = row.querySelector('.condition-help-text');
    
    if (!valueInput || !helpText) return;
    
    const operator = operatorSelect.value;
    
    if (operator === 'in_list') {
        valueInput.placeholder = 'Enter comma-separated values (e.g., yes,not sure,maybe)';
        valueInput.disabled = false;
        helpText.style.display = 'block';
    } else if (operator === 'is_empty' || operator === 'is_not_empty') {
        valueInput.placeholder = 'No value needed for this condition';
        valueInput.disabled = true;
        valueInput.value = '';
        helpText.style.display = 'none';
    } else {
        valueInput.placeholder = 'Expected value';
        valueInput.disabled = false;
        helpText.style.display = 'none';
    }
}

// Add event listeners for operator changes
document.addEventListener('change', function(event) {
    if (event.target && event.target.name === 'condition_operator[]') {
        updateConditionalValuePlaceholder(event.target);
    }
});

// Initialize placeholders for existing operator selects
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('select[name="condition_operator[]"]').forEach(select => {
        updateConditionalValuePlaceholder(select);
    });
});

function setDependentFieldValues(containerSelector) {
    // Set the dependent field values after dropdowns are populated
    const container = document.querySelector(`#${containerSelector}`);
    if (!container) return;
    
    const rowsWithConditions = container.querySelectorAll('.form-field-row[data-dependent-field]');
    rowsWithConditions.forEach(row => {
        const dependentFieldValue = row.getAttribute('data-dependent-field');
        const dependentFieldSelect = row.querySelector('select[name="condition_field[]"]');
        
        if (dependentFieldSelect && dependentFieldValue) {
            console.log(`Setting dependent field value: ${dependentFieldValue} for row`);
            dependentFieldSelect.value = dependentFieldValue;
            
            // Remove the data attribute after setting the value
            row.removeAttribute('data-dependent-field');
        }
    });
}

function setConditionalFieldValues(formFields) {
    // Set conditional field values based on original form data
    const container = document.getElementById('editFormFieldsContainer');
    if (!container || !formFields) return;
    
    const fieldRows = Array.from(container.querySelectorAll('.form-field-row'));
    
    formFields.forEach((fieldData, fieldIndex) => {
        if (!fieldData.condition) return;
        
        const fieldRow = fieldRows[fieldIndex];
        if (!fieldRow) return;
        
        const conditionalContainer = fieldRow.querySelector('.conditional-container');
        if (!conditionalContainer) return;
        
        console.log(`Setting conditional values for field ${fieldIndex}: ${fieldData.label}`, fieldData.condition);
        
        // Handle multiple conditions format
        if (fieldData.condition.rules && Array.isArray(fieldData.condition.rules)) {
            fieldData.condition.rules.forEach((rule, ruleIndex) => {
                const conditionRules = conditionalContainer.querySelectorAll('.condition-rule');
                const currentRule = conditionRules[ruleIndex];
                
                if (currentRule) {
                    const dependentSelect = currentRule.querySelector('.dependent-field-select');
                    if (dependentSelect && rule.dependent_field) {
                        dependentSelect.value = rule.dependent_field;
                        console.log(`Set dependent field: ${rule.dependent_field} for rule ${ruleIndex}`);
                    }
                }
            });
        }
        // Handle single condition format
        else if (fieldData.condition.dependent_field) {
            const firstRule = conditionalContainer.querySelector('.condition-rule');
            if (firstRule) {
                const dependentSelect = firstRule.querySelector('.dependent-field-select');
                if (dependentSelect) {
                    dependentSelect.value = fieldData.condition.dependent_field;
                    console.log(`Set single dependent field: ${fieldData.condition.dependent_field}`);
                }
            }
        }
    });
}

function collectFieldCentricData(form) {
    console.log('🔍 COLLECTING FIELD-CENTRIC DATA:');
    
    const fieldRows = form.querySelectorAll('.form-field-row');
    const fieldsData = [];
    
    fieldRows.forEach((row, index) => {
        const labelInput = row.querySelector('input[name="field_labels[]"]');
        const typeSelect = row.querySelector('select[name="field_types[]"]');
        const optionsInput = row.querySelector('input[name="field_options[]"]');
        const requiredCheckbox = row.querySelector('input[name="field_required[]"]');
        const allowOtherCheckbox = row.querySelector('input[name="allow_other[]"]');
        const locationInput = row.querySelector('input[name="location_field_identifier[]"]');
        const conditionalCheckbox = row.querySelector('.conditional-checkbox');
        
        if (!labelInput || !typeSelect) return; // Skip invalid rows
        
        const fieldData = {
            label: labelInput.value.trim(),
            type: typeSelect.value,
            options: optionsInput ? optionsInput.value.split(',').map(opt => opt.trim()).filter(opt => opt) : [],
            required: requiredCheckbox ? requiredCheckbox.checked : false,
            allow_other: allowOtherCheckbox ? allowOtherCheckbox.checked : false,
            location_field_identifier: locationInput ? locationInput.value || null : null,
            condition: null
        };
        
        // Collect condition data if field is conditional
        if (conditionalCheckbox && conditionalCheckbox.checked) {
            const conditionRules = row.querySelectorAll('.condition-rule');
            const rules = [];
            let logic = 'OR';
            
            // Get logic type
            const logicSelect = row.querySelector('.condition-logic-select');
            if (logicSelect) {
                logic = logicSelect.value || 'OR';
            }
            
            // Collect all condition rules for this field
            conditionRules.forEach(ruleElement => {
                const dependentSelect = ruleElement.querySelector('.dependent-field-select');
                const operatorSelect = ruleElement.querySelector('select[name="condition_operator[]"]');
                const valueInput = ruleElement.querySelector('input[name="condition_value[]"]');
                
                if (dependentSelect && operatorSelect) {
                    const dependentField = dependentSelect.value.trim();
                    const operator = operatorSelect.value;
                    const value = valueInput ? valueInput.value : '';
                    
                    // Only add if dependent field is not empty
                    if (dependentField) {
                        rules.push({
                            dependent_field: dependentField,
                            operator: operator,
                            value: value
                        });
                    }
                }
            });
            
            // Set condition format based on number of rules
            if (rules.length === 1) {
                // Single condition - use simple format for backward compatibility
                fieldData.condition = rules[0];
            } else if (rules.length > 1) {
                // Multiple conditions - use complex format
                fieldData.condition = {
                    logic: logic,
                    rules: rules
                };
            }
            // If no valid rules, condition stays null
        }
        
        fieldsData.push(fieldData);
        console.log(`Field ${index}: ${fieldData.label}`, fieldData);
    });
    
    return fieldsData;
}

function debugFormSubmission(form) {
    console.log('🔍 FORM SUBMISSION DEBUG (OLD METHOD):');
    
    // Collect field-centric data
    const fieldsData = collectFieldCentricData(form);
    
    // Add a hidden input with the structured data
    const existingFieldsInput = form.querySelector('input[name="fields_data"]');
    if (existingFieldsInput) {
        existingFieldsInput.remove();
    }
    
    const fieldsDataInput = document.createElement('input');
    fieldsDataInput.type = 'hidden';
    fieldsDataInput.name = 'fields_data';
    fieldsDataInput.value = JSON.stringify(fieldsData);
    form.appendChild(fieldsDataInput);
    
    console.log('✅ Added structured fields_data to form:', fieldsData);
    
    return true; // Allow form submission to continue
}

</script>
{% endblock %} 