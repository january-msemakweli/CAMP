{% extends "base.html" %}

{% block content %}
<style>
    /* Style for required fields with error */
    .has-error .choices__inner {
        border-color: #dc3545 !important;
    }
    
    /* Style for invalid feedback message */
    .invalid-feedback {
        display: none;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 80%;
        color: #dc3545;
    }
    
    /* Modified dropdown approach - contained within parent */
    #searchResultsPortal {
        position: relative;
        width: 100%;
        pointer-events: none;
        z-index: 1000; /* Higher z-index to ensure visibility */
    }
    
    #searchPatientIdResults {
        position: absolute;
        max-height: 300px;
        overflow-y: auto;
        background-color: white;
        border-radius: 0.25rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        border: 1px solid rgba(0,0,0,0.2);
        min-width: 250px;
        display: none;
        pointer-events: auto;
        z-index: 1000; /* Higher z-index to ensure visibility */
    }
    
    #searchPatientIdResults.visible {
        display: block;
    }
    
    #searchPatientIdResults .list-group-item {
        padding: 8px 12px;
        cursor: pointer;
    }
    
    #searchPatientIdResults .list-group-item:hover {
        background-color: #f0f7ff;
    }
    
    /* Ensure search container can expand beyond its parent if needed */
    .search-container {
        position: relative;
        z-index: 1000; /* Higher z-index to ensure visibility */
    }
    
    /* Make sure the patient ID section doesn't clip its children */
    #patientIdSection {
        overflow: visible;
        position: relative;
    }
    
    /* Enhanced UI for checkbox and radio selections */
    .custom-option-card {
        cursor: pointer;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 0.75rem 1rem;
        margin-bottom: 0.5rem;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
    }
    
    .custom-option-card:hover {
        border-color: #adb5bd;
        background-color: #f8f9fa;
    }
    
    .custom-option-card input[type="radio"],
    .custom-option-card input[type="checkbox"] {
        margin-right: 10px;
    }
    
    .custom-option-card.selected {
        border-color: #0d6efd;
        background-color: #e7f1ff;
    }
    
    /* Hide default input styles */
    .custom-option-card input[type="radio"],
    .custom-option-card input[type="checkbox"] {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
    }
    
    /* Custom checkbox/radio indicator */
    .custom-option-card .checkmark {
        height: 20px;
        width: 20px;
        min-width: 20px;
        background-color: #fff;
        border: 1px solid #ced4da;
        border-radius: 3px;
        margin-right: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .custom-option-card input[type="radio"] + .checkmark {
        border-radius: 50%;
    }
    
    .custom-option-card.selected .checkmark {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    
    .custom-option-card.selected .checkmark:after {
        content: '\2713';
        display: block;
        color: white;
        font-size: 14px;
        line-height: 1;
    }
    
    /* Mobile styling for buttons */
    @media (max-width: 767.98px) {
        #usePatientIdBtn .fas,
        #clearPatientIdBtn .fas {
            margin-right: 0 !important;
        }
        
        #usePatientIdBtn,
        #clearPatientIdBtn {
            padding: 0.25rem 0.5rem;
            min-width: 38px;
        }
    }
</style>

<!-- Search results container moved into the search container -->
<div class="row mb-4">
    <div class="col-12">
        <h2>{{ form.title }}</h2>
        <p class="text-muted">Programme: {{ project.name }}</p>
        {# Pass is_first_form flag from backend #}
        {% if is_first_form %}
            <span class="badge bg-info">Registration Form</span>
        {% endif %}
    </div>
</div>

<div class="row">
    {# Form Column #}
    <div class="col-md-7 mb-4">
        <div class="card" style="overflow: visible;">
            <div class="card-header">
                <h5 class="mb-0">Data Entry</h5>
            </div>
            <div class="card-body" style="overflow: visible;">
                {# Patient ID Workflow UI remains here #}
                <div id="patientIdSection" class="mb-4 p-3 border rounded bg-light">
                    <h6 class="mb-3">Patient Identification</h6>
                    <div class="row g-2 align-items-end">
                        {# Conditionally show Create button only for the first form #}
                        {% if is_first_form %}
                        <div class="col-auto">
                            <button type="button" id="createPatientIdBtn" class="btn btn-success">
                                <i class="fas fa-plus me-1"></i> Create New Patient ID
                            </button>
                        </div>
                        {% else %}
                         <div class="col-12">
                            <div class="alert alert-warning small p-2">
                                <i class="fas fa-info-circle me-1"></i> New patient IDs can only be created from the programme's first form (Registration).
                            </div>
                         </div>
                        {% endif %}
                        
                        {# Search Section (Always shown, but functionality might differ) #}
                        <div class="col search-container">
                            <label for="searchPatientIdInput" class="form-label visually-hidden">Search Existing Patient ID</label>
                            <input type="search" id="searchPatientIdInput" class="form-control" placeholder="Search by Patient ID or Name...">
                            <!-- Search results container moved here -->
                            <div id="searchResultsPortal">
                                <div id="searchPatientIdResults" class="list-group mt-1"></div>
                            </div>
                        </div>
                    </div>
                    <div id="selectedPatientIdDisplay" class="mt-3" style="display: none;">
                        <span class="badge bg-primary fs-6 me-2">Selected: <strong id="selectedPatientIdValue"></strong></span>
                        <button type="button" id="usePatientIdBtn" class="btn btn-sm btn-primary" disabled title="Use This ID for Form">
                            <i class="fas fa-check"></i>
                        </button>
                        <button type="button" id="clearPatientIdBtn" class="btn btn-sm btn-outline-secondary ms-1" title="Clear">
                             <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                {# --- End Patient ID Workflow UI --- #}

                {# Form Separator #}
                <hr id="formSeparator" style="display: none;" />
                    
                {# Data Entry Form #}
                <form id="dataEntryForm" method="POST" action="{{ url_for('submit_form', form_id=form.id) }}" style="display: none;" data-form-id="{{ form.id }}">
                    {# Hidden input #}
                    <input type="hidden" id="patientIdInput" name="patient_id" value="">
                    {# Form fields loop #}
                    {% for field in form.fields %}
                    <div class="mb-3">
                        <label class="form-label" for="field-{{ loop.index }}">{{ field.label }}</label>
                        {% if field.location_type %}
                            {# Add specific class based on location_type #}
                            {% set location_class = 'location-' + field.location_type %}
                            <select class="form-select location-dropdown choices-select {{ location_class }}" 
                                    id="field-{{ loop.index }}" 
                                    name="{{ field.label }}" 
                                    {# Keep data-location-type for potential future use, but select by class #}
                                    data-location-type="{{ field.location_type }}" 
                                    {% if field.required %}required{% endif %}
                                    {% if field.location_type != 'region' %}disabled{% endif %}>
                                {# Options will be populated by JS #}
                            </select>
                        {% elif field.type == 'text' %}
                            <input type="text" class="form-control" id="field-{{ loop.index }}" name="{{ field.label }}" {% if field.required %}required{% endif %}>
                        {% elif field.type == 'number' %}
                            <input type="number" class="form-control" id="field-{{ loop.index }}" name="{{ field.label }}" {% if field.required %}required{% endif %}>
                        {% elif field.type == 'date' %}
                            <input type="date" class="form-control" id="field-{{ loop.index }}" name="{{ field.label }}" {% if field.required %}required{% endif %}>
                        {% elif field.type == 'dropdown' %}
                            <select class="form-select choices-select" 
                                   id="field-{{ loop.index }}" 
                                   name="{{ field.label }}" 
                                   {% if field.required %}required aria-required="true"{% endif %}>
                                <option value="">Select an option</option>
                                {% for option in field.options %}
                                <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        {% elif field.type == 'radio' %}
                            <div class="custom-options-group">
                                {% for option in field.options %}
                                <label class="custom-option-card" for="field-{{ loop.index }}-{{ loop.index0 }}">
                                    <input class="form-check-input" type="radio" name="{{ field.label }}" id="field-{{ loop.index }}-{{ loop.index0 }}" value="{{ option }}" {% if field.required %}required{% endif %}>
                                    <span class="checkmark"></span>
                                    <span>{{ option }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        {% elif field.type == 'checkbox' %}
                            <div class="custom-options-group">
                                {% for option in field.options %}
                                <label class="custom-option-card" for="field-{{ loop.index }}-{{ loop.index0 }}">
                                    <input class="form-check-input" type="checkbox" name="{{ field.label }}" id="field-{{ loop.index }}-{{ loop.index0 }}" value="{{ option }}">
                                    <span class="checkmark"></span>
                                    <span>{{ option }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    <button type="submit" class="btn btn-primary w-100">Submit Form Data</button>
                </form>
            </div>
        </div>
    </div> {# End of col-md-7 #}
    
    {# Preview Column #}
    <div class="col-md-5 mb-4">
        <div id="patientPreviewCard" class="card"> {# Removed style="display: none;" #}
            <div class="card-header">
                <h6 class="mb-0">Patient Preview</h6>
            </div>
            <div class="card-body" id="patientPreviewBody">
                <p class="text-center text-muted">Search and select a patient ID to view details.</p> {# Updated placeholder #}
            </div>
        </div>
        
        {% if current_user.is_admin %}
        <!-- Form Access Management Card -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-key me-2"></i>Form Access Management</h6>
            </div>
            <div class="card-body">
                <h6 class="mb-3">Current Access</h6>
                {% if user_permissions %}
                <ul class="list-group list-group-flush mb-4">
                    {% for permission in user_permissions %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                            <i class="fas fa-user me-1"></i>
                            {{ permission.users.username }}
                        </span>
                        <form method="POST" action="{{ url_for('revoke_form_access', form_id=form.id, permission_id=permission.id) }}" 
                            class="d-inline" onsubmit="return confirm('Are you sure you want to revoke access for this user?')">
                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                <i class="fas fa-user-times"></i> Revoke
                            </button>
                        </form>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>No users have specific access to this form yet.
                </div>
                {% endif %}
                
                <h6 class="mb-3">Grant Access</h6>
                <form method="POST" action="{{ url_for('grant_form_access', form_id=form.id) }}">
                    <div class="mb-3">
                        <label for="userSelect" class="form-label">Select User</label>
                        <select class="form-select" id="userSelect" name="user_id" required>
                            <option value="">-- Select User --</option>
                            {% for user in users %}
                                {% if not user.id in user_permissions|map(attribute='user_id')|list %}
                                <option value="{{ user.id }}">{{ user.username }}</option>
                                {% endif %}
                            {% endfor %}
                            {% if not users %}
                            <option value="" disabled>No users with project access found - grant project access first</option>
                            {% endif %}
                        </select>
                        <div class="form-text">Only users with project access are shown. <a href="{{ url_for('project_detail', project_id=project.id) }}">Manage project access here</a>.</div>
                    </div>
                    <button type="submit" class="btn btn-primary" {% if not users %}disabled{% endif %}>
                        <i class="fas fa-user-plus me-1"></i> Grant Access
                    </button>
                </form>
            </div>
        </div>
        {% endif %}
    </div> {# End of col-md-5 #}

</div> {# End of row #}

{# Waitlist Section - Only shown if enabled by admin #}
{% if show_waitlist or current_user.is_admin %}
<div class="row mt-4 mb-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Patient Waitlist</h5>
                <div>
                    <button id="refreshWaitlistBtn" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    
                    {% if current_user.is_admin %}
                    <!-- Admin control for waitlist visibility -->
                    <button id="toggleWaitlistBtn" class="btn btn-sm {{ 'btn-danger' if show_waitlist else 'btn-success' }} ms-2" 
                            data-form-id="{{ form.id }}" 
                            data-current-status="{{ show_waitlist }}">
                        <i class="fas {{ 'fa-eye-slash' if show_waitlist else 'fa-eye' }} me-1"></i>
                        {{ 'Hide Waitlist' if show_waitlist else 'Show Waitlist' }}
                    </button>
                    
                    {% if not show_waitlist %}
                    <div class="alert alert-info mt-2 mb-0 py-2 small">
                        <i class="fas fa-info-circle me-1"></i>
                        This waitlist is only visible to admins. Click "Show Waitlist" to make it visible to all users with form access.
                    </div>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div id="waitlistContainer">
                    <p class="text-center text-muted py-3">
                        <span class="spinner-border spinner-border-sm me-2"></span>Loading waitlist...
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<!-- Include Choices.js CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
<!-- Include Choices.js JS -->
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

<!-- Include locations data -->
<script src="{{ url_for('static', filename='js/locations.js') }}"></script> 

<script>
// Global function to fetch and display patient preview
// This needs to be in global scope so it can be called from any script section
function displayPatientPreview(patientId) {
    const previewBody = document.getElementById('patientPreviewBody');
    if (!previewBody) return;

    // Don't hide/show the card, just update the body
    // previewCard.style.display = 'block'; 
    previewBody.innerHTML = '<p class="text-center text-muted"><span class="spinner-border spinner-border-sm me-2"></span>Loading preview...</p>';

    fetch(`/api/patient_preview/${patientId}`)
        .then(response => {
            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error('Patient data not found. Database tables may not be set up correctly.');
                } else {
                    // Try to get error message from JSON body if possible
                    return response.json().then(errData => { 
                        throw new Error(errData.error || `HTTP error ${response.status}`); 
                    }).catch(() => {
                        // Fallback if response body isn't JSON or error field missing
                        throw new Error(`HTTP error ${response.status}`);
                    });
                }
            }
            return response.json();
        })
        .then(data => {
            // Process the response structure: { patient_record: {...}, form_details: {form_id: {title: ..., field_order: [...]}} }
            if (!data || !data.patient_record) {
                console.error('Invalid data received from API:', data);
                previewBody.innerHTML = '<p class="text-danger">Error: Could not load patient details from API.</p>';
                return;
            }
            
            const patient = data.patient_record;
            const formDetailsMap = data.form_details || {}; // Use provided details or default to empty object
            
            // Helper function to escape HTML special characters
            function escapeHtml(unsafe) {
                if (unsafe === null || typeof unsafe === 'undefined') return '';
                return String(unsafe)
                     .replace(/&/g, "&amp;")
                     .replace(/</g, "&lt;")
                     .replace(/>/g, "&gt;")
                     .replace(/"/g, "&quot;")
                     .replace(/'/g, "&#039;");
             }

            // Build basic patient info
            let content = '<dl class="row">' + 
                          `<dt class="col-sm-3">Patient ID</dt><dd class="col-sm-9">${escapeHtml(patient.patient_id)}</dd>` + 
                          `<dt class="col-sm-3">Created</dt><dd class="col-sm-9">${patient.created_at_eat ? new Date(patient.created_at_eat).toLocaleString('en-GB') : 'N/A'}</dd>` + // Added locale for clarity
                          '</dl>';

            // Build accordion for form data
            const patientFormData = patient.data;
            if (patientFormData && typeof patientFormData === 'object' && Object.keys(patientFormData).length > 0) {
                content += '<h6>Previous Form Data:</h6>';
                content += '<div class="accordion accordion-flush" id="patientDataAccordion">'; // Added accordion-flush for less border
                
                for (const [formId, formData] of Object.entries(patientFormData)) {
                     const formDetails = formDetailsMap[formId]; // Get details for this form
                     const formTitle = formDetails ? formDetails.title : `Form ID: ${formId}`; 
                     const fieldOrder = formDetails ? formDetails.field_order : null; // Get the ordered labels
                     
                     let safeFormTitle = escapeHtml(formTitle);
                     let safeFormId = escapeHtml(formId);

                     content += `
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading-${safeFormId}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${safeFormId}" aria-expanded="false" aria-controls="collapse-${safeFormId}">
                                ${safeFormTitle} <span class="text-muted ms-2 small">(${safeFormId.substring(0,8)}...)</span>
                            </button>
                            </h2>
                            <div id="collapse-${safeFormId}" class="accordion-collapse collapse" aria-labelledby="heading-${safeFormId}">
                            <div class="accordion-body">
                                <dl class="row">`;
                                
                    if (typeof formData === 'object' && formData !== null) {
                        // --- Use fieldOrder if available --- 
                        if (fieldOrder && Array.isArray(fieldOrder) && fieldOrder.length > 0) {
                            console.log(`Using field order for form ${formId}:`, fieldOrder);
                            for (const fieldLabel of fieldOrder) {
                                // Check if the label actually exists in the submitted data
                                if (formData.hasOwnProperty(fieldLabel)) {
                                    const fieldValue = formData[fieldLabel];
                                    const displayValue = escapeHtml(Array.isArray(fieldValue) ? fieldValue.join(', ') : fieldValue);
                                    content += `<dt class="col-sm-5">${escapeHtml(fieldLabel)}</dt><dd class="col-sm-7 text-break">${displayValue || '<em>(empty)</em>'}</dd>`;
                                }
                            }
                        } else {
                            // --- Fallback to iterating data object if no order --- 
                            console.warn(`No field order found for form ${formId}, using default object iteration.`);
                            for (const [fieldLabel, fieldValue] of Object.entries(formData)) {
                                const displayValue = escapeHtml(Array.isArray(fieldValue) ? fieldValue.join(', ') : fieldValue);
                                content += `<dt class="col-sm-5">${escapeHtml(fieldLabel)}</dt><dd class="col-sm-7 text-break">${displayValue || '<em>(empty)</em>'}</dd>`;
                            }
                        }
                        // ------------------------------------
                    } else {
                         content += `<dd class="col-12"><em>Invalid/non-object data format for this form entry.</em></dd>`;
                    }
                    content += '</dl></div></div></div>'; // Close dl, accordion-body, accordion-collapse, accordion-item
                }
                content += '</div>'; // End accordion
            } else {
                content += '<p><em>No previous form data recorded for this patient.</em></p>';
            }
            previewBody.innerHTML = content;
        })
        .catch(error => {
            console.error('Error fetching patient preview:', error);
            previewBody.innerHTML = `<p class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Could not load patient preview: ${error.message}</p>`;
        });
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded. Initializing scripts...'); // Log start

    // --- Choices.js Initialization (Apply to all selects - RUNS IMMEDIATELY) ---
    const allDropdowns = document.querySelectorAll('select.form-select:not([multiple])'); 
    console.log(`Found ${allDropdowns.length} dropdowns to initialize with Choices.js`); 
    allDropdowns.forEach(el => {
        // Avoid re-initializing 
        if (!el.choicesInstance) { 
            el.choicesInstance = new Choices(el, {
        searchEnabled: true,
                itemSelectText: 'Press to select',
                shouldSort: false, 
                allowHTML: false,
            });
        }
    });
    console.log('Choices.js initialization complete.'); // Log after init

    // --- Initialize Custom Card Style Checkboxes and Radio Buttons ---
    const customOptionCards = document.querySelectorAll('.custom-option-card');
    
    customOptionCards.forEach(card => {
        const input = card.querySelector('input');
        
        // Set initial selected state
        if (input.checked) {
            card.classList.add('selected');
        }
        
        // Add click event to the card
        card.addEventListener('click', function(e) {
            // If clicked on the input itself, let the default behavior happen
            if (e.target === input) return;
            
            // Prevent default to handle our own logic
            e.preventDefault();
            
            if (input.type === 'radio') {
                // Deselect all other cards in the same group
                document.querySelectorAll(`input[name="${input.name}"]`).forEach(radio => {
                    radio.closest('.custom-option-card').classList.remove('selected');
                });
                // Select this card
                card.classList.add('selected');
                input.checked = true;
            } else if (input.type === 'checkbox') {
                // Toggle selected state
                card.classList.toggle('selected');
                input.checked = !input.checked;
            }
            
            // Trigger change event
            const changeEvent = new Event('change', { bubbles: true });
            input.dispatchEvent(changeEvent);
        });
        
        // Listen for direct input changes as well
        input.addEventListener('change', function() {
            if (this.checked) {
                card.classList.add('selected');
                
                // For radio buttons, deselect others
                if (this.type === 'radio') {
                    document.querySelectorAll(`input[name="${this.name}"]`).forEach(radio => {
                        if (radio !== this) {
                            radio.closest('.custom-option-card').classList.remove('selected');
                        }
                    });
                }
            } else {
                card.classList.remove('selected');
            }
        });
    });

    // --- Find Location Dropdowns by NAME (after init) ---
    let regionDropdown = null;
    let districtDropdown = null;
    let wardDropdown = null;

    allDropdowns.forEach(el => {
        if (el.name === 'Region') {
            regionDropdown = el;
        } else if (el.name === 'District') {
            districtDropdown = el;
        } else if (el.name === 'Ward') {
            wardDropdown = el;
        }
    });
    console.log('Region Dropdown Element (by name):', regionDropdown);
    console.log('District Dropdown Element (by name):', districtDropdown);
    console.log('Ward Dropdown Element (by name):', wardDropdown);
    // --------------------------------------------------

    // --- Location Dropdown Logic ---
    console.log('Running location logic...');

    // Helper Function: Populate Dropdown 
    function populateDropdown(dropdownElement, optionsArray) {
        // Add null check for dropdownElement itself
        if (!dropdownElement) {
            console.error("populateDropdown called with null element");
            return;
        }
        const choicesInstance = dropdownElement.choicesInstance;
        console.log('Inside populateDropdown for:', dropdownElement, 'Choices Instance:', choicesInstance);
        if (!choicesInstance) {
            console.error('Choices instance not found for:', dropdownElement);
            // Fallback: Maybe try initializing Choices here if not found?
            // Or just disable the raw element
            dropdownElement.disabled = true;
            return;
        }
        choicesInstance.clearStore(); 
        choicesInstance.clearInput();
        const choices = optionsArray.map(option => ({ value: option, label: option }));
        choicesInstance.setChoices(choices, 'value', 'label', true); 
        choicesInstance.enable();
        console.log('Enabled choices for:', dropdownElement);
    }

    // Helper Function: Reset Dropdown
    function resetDropdown(dropdownElement) {
        // Add null check for dropdownElement itself
        if (!dropdownElement) {
             console.error("resetDropdown called with null element");
            return;
        }
        const choicesInstance = dropdownElement.choicesInstance;
        if (!choicesInstance) { 
            // If no instance, just disable the raw element
             console.warn('Choices instance not found for reset, disabling raw element:', dropdownElement);
            dropdownElement.disabled = true;
            return; 
        }
        choicesInstance.clearStore(); 
        choicesInstance.clearInput(); 
        choicesInstance.disable();
    }

    // Populate Initial Regions - Simplified Check
    if (regionDropdown && LOCATION_DATA) {
        const regions = Object.keys(LOCATION_DATA).sort();
        // Attempt to set config and populate, relying on checks inside populateDropdown
        if (regionDropdown.choicesInstance) { // Check instance before accessing config
             regionDropdown.choicesInstance.config.shouldSort = true; 
        } else {
             console.warn('Cannot set shouldSort, choicesInstance not found yet for Region');
        }
        populateDropdown(regionDropdown, regions);
    } else {
        console.error('Could not populate initial regions. Region dropdown or LOCATION_DATA missing.');
        if(regionDropdown) regionDropdown.disabled = true; // Disable raw element if found but data missing
    }
    
    // Add Event Listeners FIRST
    if (regionDropdown && districtDropdown) {
        regionDropdown.addEventListener('change', function() {
            console.log('Region changed. Selected value:', this.value);
            resetDropdown(districtDropdown);
            if (wardDropdown) resetDropdown(wardDropdown);
            
            const selectedRegion = this.value; // Choices.js sets the value on the original select
            if (selectedRegion && LOCATION_DATA[selectedRegion]) {
                console.log('Found districts for region:', selectedRegion);
                const districts = Object.keys(LOCATION_DATA[selectedRegion]).sort();
                console.log('Populating districts:', districts);
                populateDropdown(districtDropdown, districts);
            } else {
                 console.log('No districts found or no region selected for:', selectedRegion);
                 if(districtDropdown && districtDropdown.choicesInstance) districtDropdown.choicesInstance.disable(); 
                 else if(districtDropdown) districtDropdown.disabled = true;
                 if(wardDropdown && wardDropdown.choicesInstance) wardDropdown.choicesInstance.disable();
                 else if(wardDropdown) wardDropdown.disabled = true;
            }
        });
    }

    if (districtDropdown && wardDropdown) {
        districtDropdown.addEventListener('change', function() {
            console.log('District changed. Selected value:', this.value);
            resetDropdown(wardDropdown);
            const selectedRegion = regionDropdown ? regionDropdown.value : null; // Need region value
            const selectedDistrict = this.value;
            console.log(`Looking for wards in Region: ${selectedRegion}, District: ${selectedDistrict}`);
            if (selectedRegion && selectedDistrict && LOCATION_DATA[selectedRegion] && LOCATION_DATA[selectedRegion][selectedDistrict]) {
                console.log('Found wards for district:', selectedDistrict);
                const wards = LOCATION_DATA[selectedRegion][selectedDistrict].sort();
                console.log('Populating wards:', wards);
                populateDropdown(wardDropdown, wards);
            } else {
                 console.log('No wards found or no district/region selected.');
                 if(wardDropdown && wardDropdown.choicesInstance) wardDropdown.choicesInstance.disable();
                 else if(wardDropdown) wardDropdown.disabled = true;
            }
        });
    }

    // Disable district and ward initially using reset function AFTER listeners are attached
    resetDropdown(districtDropdown);
    resetDropdown(wardDropdown);

    // --- Patient ID Workflow JavaScript (Remains unchanged) ---
    const createBtn = document.getElementById('createPatientIdBtn');
    const searchInput = document.getElementById('searchPatientIdInput');
    const searchResultsContainer = document.getElementById('searchPatientIdResults');
    const selectedDisplay = document.getElementById('selectedPatientIdDisplay');
    const selectedValueSpan = document.getElementById('selectedPatientIdValue');
    const useIdBtn = document.getElementById('usePatientIdBtn');
    const clearIdBtn = document.getElementById('clearPatientIdBtn');
    const patientIdInputHidden = document.getElementById('patientIdInput');
    const dataEntryForm = document.getElementById('dataEntryForm');
    const formSeparator = document.getElementById('formSeparator');
    const patientIdSection = document.getElementById('patientIdSection');

    let searchTimeout;
    const previewCard = document.getElementById('patientPreviewCard');
    const previewBody = document.getElementById('patientPreviewBody');
    const defaultPreviewMessage = '<p class="text-center text-muted">Search and select a patient ID to view details.</p>';

    // --- ADDED: Function to fetch and pre-fill answers ---
    function fetchAndPrefillAnswers(formId, patientId) {
        fetch(`/api/form/${formId}/answers/${patientId}`)
            .then(response => response.json())
            .then(data => {
                if (!data || typeof data !== 'object') return;
                Object.entries(data).forEach(([label, value]) => {
                    // Try to find the field by name
                    const field = dataEntryForm.querySelector(`[name="${label}"]`);
                    if (field) {
                        if (field.type === 'checkbox') {
                            // For checkboxes, value is expected to be an array
                            if (Array.isArray(value)) {
                                const checkboxes = dataEntryForm.querySelectorAll(`[name="${label}"]`);
                                checkboxes.forEach(cb => {
                                    cb.checked = value.includes(cb.value);
                                    // Update custom card UI if present
                                    if (cb.closest('.custom-option-card')) {
                                        if (cb.checked) cb.closest('.custom-option-card').classList.add('selected');
                                        else cb.closest('.custom-option-card').classList.remove('selected');
                                    }
                                });
                            }
                        } else if (field.type === 'radio') {
                            // For radios, value is a string
                            const radios = dataEntryForm.querySelectorAll(`[name="${label}"]`);
                            radios.forEach(radio => {
                                radio.checked = (radio.value == value);
                                if (radio.closest('.custom-option-card')) {
                                    if (radio.checked) radio.closest('.custom-option-card').classList.add('selected');
                                    else radio.closest('.custom-option-card').classList.remove('selected');
                                }
                            });
                        } else {
                            // For text, number, date, dropdown
                            field.value = value;
                            // If Choices.js, update the UI
                            if (field.choicesInstance) {
                                field.choicesInstance.setChoiceByValue(value);
                            }
                        }
                    }
                });
            });
    }

    // Function to show the form once an ID is selected and confirmed
    function activateForm(patientId) {
        patientIdInputHidden.value = patientId;
        dataEntryForm.style.display = 'block';
        formSeparator.style.display = 'block';
        // Disable workflow UI
        if(createBtn) createBtn.disabled = true;
        searchInput.disabled = true;
        useIdBtn.disabled = true;
        searchResultsContainer.innerHTML = '';
        selectedDisplay.style.display = 'flex'; // Ensure display is flex
        selectedValueSpan.textContent = patientId;
        // --- ADDED: Fetch and prefill answers ---
        const formId = dataEntryForm.getAttribute('data-form-id');
        if (formId && patientId) {
            fetchAndPrefillAnswers(formId, patientId);
        }
    }

    // Function to reset the workflow UI
    function resetWorkflow() {
        patientIdInputHidden.value = '';
        dataEntryForm.style.display = 'none';
        formSeparator.style.display = 'none';
        selectedDisplay.style.display = 'none';
        selectedValueSpan.textContent = '';
        if(createBtn) createBtn.disabled = false;
        searchInput.disabled = false;
        searchInput.value = '';
        searchResultsContainer.innerHTML = ''; 
        useIdBtn.disabled = true;
        // Set preview body back to default message on reset
        if (previewBody) previewBody.innerHTML = defaultPreviewMessage;
    }

    // Set initial state for preview body
    if (previewBody) previewBody.innerHTML = defaultPreviewMessage;

    // Event Listener for Create Button
    if (createBtn) {
        createBtn.addEventListener('click', function() {
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Creating...';
            
            fetch('/api/create_patient_id', { method: 'POST' })
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 404) {
                            throw new Error('API endpoint not found. Check server configuration.');
                        } else {
                            return response.json().then(errData => {
                                throw new Error(errData.error || `Server error: ${response.status}`);
                            }).catch(err => {
                                throw new Error(`Failed to create patient ID: ${response.status}`);
                            });
                        }
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        alert('Error creating patient ID: ' + data.error);
                        this.disabled = false;
                         this.innerHTML = '<i class="fas fa-plus me-1"></i> Create New Patient ID';
                    } else {
                        // ID created, show it and enable 'Use ID'
                        selectedValueSpan.textContent = data.patient_id;
                        selectedDisplay.style.display = 'flex';
                        useIdBtn.disabled = false;
                         this.innerHTML = '<i class="fas fa-check"></i> ID Created!'; // Feedback
                         searchInput.disabled = true; // Disable search while ID is pending use
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    alert('An network error occurred while creating patient ID.');
                     this.disabled = false;
                     this.innerHTML = '<i class="fas fa-plus me-1"></i> Create New Patient ID';
                });
        });
    }

    // Event Listener for Search Input (with debounce)
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length < 2) { // Only search if query is at least 2 chars
            searchResultsContainer.innerHTML = '';
            searchResultsContainer.classList.remove('visible');
            return;
        }

        // Position the dropdown below the search input
        positionDropdown();

        // Show the loading state immediately
        searchResultsContainer.innerHTML = '<div class="list-group-item">Searching...</div>';
        searchResultsContainer.classList.add('visible');
        
        // Hide selected display on new search
        selectedDisplay.style.display = 'none';
        useIdBtn.disabled = true;
        if(createBtn) createBtn.disabled = false; // Re-enable create button

        searchTimeout = setTimeout(() => {
            fetch(`/api/search_patient_id?q=${encodeURIComponent(query)}`)
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 404) {
                            throw new Error('Search endpoint not found. Check server configuration.');
                        } else {
                            throw new Error(`Server error: ${response.status}`);
                        }
                    }
                    return response.json();
                })
                .then(data => {
                    searchResultsContainer.innerHTML = ''; // Clear "Searching..."
                    
                    if (data.error) {
                        searchResultsContainer.innerHTML = `<div class="list-group-item text-danger">Error: ${data.error}</div>`;
                    } else if (data.length === 0) {
                        searchResultsContainer.innerHTML = '<div class="list-group-item">No matching patient IDs found.</div>';
                    } else {
                        // Create all elements before adding to the DOM
                        const fragment = document.createDocumentFragment();
                        
                        data.forEach(patient => {
                            const item = document.createElement('button');
                            item.type = 'button';
                            item.className = 'list-group-item list-group-item-action';
                            
                            // Display patient ID and name if available
                            if (patient.display_name) {
                                // Create content with ID and name
                                item.innerHTML = `<div class="d-flex justify-content-between align-items-center">
                                    <strong>${patient.patient_id}</strong>
                                    <span class="text-muted">${patient.display_name}</span>
                                </div>`;
                            } else {
                                // Just show ID if no name available
                                item.textContent = patient.patient_id;
                            }
                            
                            item.addEventListener('click', () => {
                                const selectedPatientId = patient.patient_id; // Capture ID
                                selectedValueSpan.textContent = selectedPatientId;
                                selectedDisplay.style.display = 'flex';
                                useIdBtn.disabled = false;
                                searchResultsContainer.classList.remove('visible');
                                searchResultsContainer.innerHTML = ''; // Clear results after selection
                                if(createBtn) createBtn.disabled = true; // Disable create if search result selected
                                searchInput.value = selectedPatientId; // Optional: fill search box
                                // --- Call displayPatientPreview --- 
                                displayPatientPreview(selectedPatientId);
                            });
                            
                            fragment.appendChild(item);
                        });
                        
                        // Add all elements at once
                        searchResultsContainer.appendChild(fragment);
                        
                        // Update position after content is added
                        positionDropdown();
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    searchResultsContainer.innerHTML = '<div class="list-group-item text-danger">Search failed.</div>';
                });
        }, 300); // Debounce time: 300ms
    });
    
    // Function to position the dropdown below the search input
    function positionDropdown() {
        // With the new structure, we don't need complex positioning as the dropdown
        // is already inside the search container with correct relative/absolute positioning
        searchResultsContainer.style.width = `${searchInput.offsetWidth}px`;
        
        // Make sure the dropdown has enough space to display
        const maxHeight = 300; // Maximum height for dropdown
        searchResultsContainer.style.maxHeight = `${maxHeight}px`;
        
        // Clear any left/top positioning that might have been set previously
        searchResultsContainer.style.left = '';
        searchResultsContainer.style.top = '';
        
        // Ensure the parent card doesn't clip the dropdown
        const patientIdSection = document.getElementById('patientIdSection');
        if (patientIdSection) {
            patientIdSection.style.overflow = 'visible';
        }
        
        // Also ensure the parent card has overflow visible
        const cardBody = patientIdSection ? patientIdSection.closest('.card-body') : null;
        if (cardBody) {
            cardBody.style.overflow = 'visible';
        }
        
        // And the card itself
        const card = cardBody ? cardBody.closest('.card') : null;
        if (card) {
            card.style.overflow = 'visible';
        }
    }
    
    // Reposition dropdown on scroll or resize
    window.addEventListener('resize', function() {
        if (searchResultsContainer.classList.contains('visible')) {
            positionDropdown();
        }
    });
    
    // No need to reposition on scroll since the dropdown is contained within the parent
    // This helps performance by removing the scroll event listener

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        if (!searchInput.contains(event.target) && !searchResultsContainer.contains(event.target)) {
            searchResultsContainer.classList.remove('visible');
        }
    });
    
    // Show dropdown when focusing on search input if it has content
    searchInput.addEventListener('focus', function() {
        if (this.value.trim().length >= 2 && searchResultsContainer.innerHTML.trim() !== '') {
            positionDropdown();
            searchResultsContainer.classList.add('visible');
        }
    });

    // Event Listener for "Use ID" Button
    useIdBtn.addEventListener('click', function() {
        const selectedId = selectedValueSpan.textContent;
        if (selectedId) {
            activateForm(selectedId);
        }
    });

    // Event Listener for "Clear" Button
    clearIdBtn.addEventListener('click', function() {
        resetWorkflow();
    });
    
    // Prevent form submission if patient ID is not set (extra safety)
    dataEntryForm.addEventListener('submit', function(event) {
        if (!patientIdInputHidden.value) {
            event.preventDefault();
            alert('No Patient ID is associated with this form. Please create or select one first.');
            return;
        }
        
        // Add validation for required fields, especially for dropdowns with Choices.js
        const requiredFields = dataEntryForm.querySelectorAll('[required]');
        let hasEmptyRequiredField = false;
        
        requiredFields.forEach(field => {
            if (field.tagName === 'SELECT') {
                // For dropdowns, check if a value is selected
                if (!field.value) {
                    hasEmptyRequiredField = true;
                    // Get the Choices.js instance and highlight it
                    if (field.choicesInstance) {
                        field.choicesInstance.showDropdown();
                        // Add visual indicator that field is required
                        field.closest('.mb-3').classList.add('has-error');
                        // Add error message
                        let errorMsg = field.closest('.mb-3').querySelector('.invalid-feedback');
                        if (!errorMsg) {
                            errorMsg = document.createElement('div');
                            errorMsg.className = 'invalid-feedback';
                            errorMsg.style.display = 'block';
                            errorMsg.textContent = 'This field is required';
                            field.closest('.mb-3').appendChild(errorMsg);
                        }
                    }
                }
            } else if (!field.value) {
                hasEmptyRequiredField = true;
            }
        });
        
        if (hasEmptyRequiredField) {
            event.preventDefault();
            alert('Please fill in all required fields before submitting.');
        }
    });

}); // End of the second DOMContentLoaded listener (Patient ID workflow)

// --- Waitlist Functionality ---
document.addEventListener('DOMContentLoaded', function() {
    // Get data from template using data attributes
    const waitlistContainer = document.getElementById('waitlistContainer');
    const refreshWaitlistBtn = document.getElementById('refreshWaitlistBtn');
    
    // Get form data from data attributes
    const formElement = document.getElementById('dataEntryForm');
    const formId = formElement ? formElement.dataset.formId : '';
    
    // Function to load the waitlist
    function loadWaitlist() {
        if (!waitlistContainer) return;
        
        waitlistContainer.innerHTML = `
            <p class="text-center text-muted py-3">
                <span class="spinner-border spinner-border-sm me-2"></span>Loading waitlist...
            </p>
        `;
        
        fetch(`/api/form_waitlist/${formId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (!data || !Array.isArray(data.patients)) {
                    throw new Error('Invalid data format received');
                }
                
                const patients = data.patients;
                
                if (patients.length === 0) {
                    waitlistContainer.innerHTML = `
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle me-2"></i>No patients in the waitlist for this form.
                        </div>
                    `;
                    return;
                }
                
                // Create the table for the waitlist
                let tableHtml = `
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead>
                            <tr>
                                <th>Patient ID</th>
                                <th>Name</th>
                                <th>Last Form Completed</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // Populate table with patient data
                patients.forEach(patient => {
                    tableHtml += `
                        <tr>
                            <td>${patient.patient_id}</td>
                            <td>${patient.display_name || '<em>No name</em>'}</td>
                            <td>${patient.last_form_completed || 'None'}</td>
                            <td>
                                <span class="badge bg-${patient.is_eligible ? 'success' : 'warning'}">
                                    ${patient.is_eligible ? 'Ready' : 'Pending Previous Form'}
                                </span>
                            </td>
                            <td>
                                <button 
                                    class="btn btn-sm btn-primary select-patient-btn" 
                                    data-patient-id="${patient.patient_id}"
                                    ${!patient.is_eligible ? 'disabled' : ''}
                                >
                                    Select
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += `
                        </tbody>
                    </table>
                </div>
                `;
                
                waitlistContainer.innerHTML = tableHtml;
                
                // Add event listeners to the select buttons
                document.querySelectorAll('.select-patient-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const patientId = this.getAttribute('data-patient-id');
                        if (patientId) {
                            // Use the existing patient selection functionality
                            const selectedPatientDisplay = document.getElementById('selectedPatientIdDisplay');
                            const selectedPatientIdValue = document.getElementById('selectedPatientIdValue');
                            const usePatientIdBtn = document.getElementById('usePatientIdBtn');
                            const searchInput = document.getElementById('searchPatientIdInput');
                            
                            if (selectedPatientDisplay && selectedPatientIdValue && usePatientIdBtn) {
                                selectedPatientIdValue.textContent = patientId;
                                selectedPatientDisplay.style.display = 'flex';
                                usePatientIdBtn.disabled = false;
                                if (searchInput) searchInput.value = patientId;
                                
                                // Scroll to the patient selection area
                                document.getElementById('patientIdSection').scrollIntoView({
                                    behavior: 'smooth',
                                    block: 'start'
                                });
                                
                                // Call the preview function if it exists
                                if (typeof displayPatientPreview === 'function') {
                                    displayPatientPreview(patientId);
                                }
                            }
                        }
                    });
                });
            })
            .catch(error => {
                console.error('Error loading waitlist:', error);
                waitlistContainer.innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>Failed to load waitlist: ${error.message}
                    </div>
                `;
            });
    }
    
    // Load waitlist on page load
    if (formId) {
        loadWaitlist();
    } else {
        console.error('Form ID not found, cannot load waitlist');
        if (waitlistContainer) {
            waitlistContainer.innerHTML = `
                <div class="alert alert-danger mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Unable to load waitlist: Form ID not found
                </div>
            `;
        }
    }
    
    // Refresh button event listener
    if (refreshWaitlistBtn) {
        refreshWaitlistBtn.addEventListener('click', loadWaitlist);
    }
    
    // Toggle waitlist visibility (admin only)
    const toggleWaitlistBtn = document.getElementById('toggleWaitlistBtn');
    if (toggleWaitlistBtn) {
        toggleWaitlistBtn.addEventListener('click', function() {
            const formId = this.getAttribute('data-form-id');
            if (!formId) return;
            
            // Disable button and show loading state
            this.disabled = true;
            const originalHTML = this.innerHTML;
            this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Updating...';
            
            // Send request to toggle waitlist visibility
            fetch(`/api/form/${formId}/toggle_waitlist`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Show feedback
                    const toast = document.createElement('div');
                    toast.className = 'position-fixed bottom-0 end-0 p-3';
                    toast.style.zIndex = '5000';
                    toast.innerHTML = `
                        <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                            <div class="toast-header bg-success text-white">
                                <strong class="me-auto">Success</strong>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                            <div class="toast-body">
                                ${data.message}
                            </div>
                        </div>
                    `;
                    document.body.appendChild(toast);
                    
                    // Auto remove toast after 3 seconds
                    setTimeout(() => {
                        toast.remove();
                    }, 3000);
                    
                    // Refresh page to reflect changes
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    alert('Operation failed: ' + (data.error || 'Unknown error'));
                    // Reset button state
                    this.disabled = false;
                    this.innerHTML = originalHTML;
                }
            })
            .catch(error => {
                console.error('Error toggling waitlist visibility:', error);
                alert('Error: ' + error.message);
                // Reset button state
                this.disabled = false;
                this.innerHTML = originalHTML;
            });
        });
    }
});

</script>
{% endblock %} 
