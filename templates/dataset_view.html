{% extends "base.html" %}

{% block content %}
<div class="container-fluid p-4">
    <!-- Page Header -->
    <div class="page-header mb-4">
        <div class="row align-items-center">
            <div class="col">
                <h2 class="mb-1"><i class="fas fa-database me-2"></i>Dataset View</h2>
                {% if selected_project_name %}
                    <p class="text-muted mb-0">Viewing data for programme: <strong>{{ selected_project_name }}</strong></p>
                {% elif selected_project %} {# Fallback if name fetch failed but ID exists #}
                     <p class="text-muted mb-0">Viewing data for programme ID: <strong>{{ selected_project }}</strong> (Name fetch error)</p>
                {% else %}
                    <p class="text-muted mb-0">Viewing data for all programmes.</p>
                {% endif %}
            </div>
            <div class="col-auto">
                <div class="action-buttons">
                    <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#filterModal">
                        <i class="fas fa-filter me-2"></i>Filter Data
                    </button>
                    {% if current_user.is_admin %}
                    <a href="{{ url_for('export_dataset', project_id=selected_project, form_id=selected_form, start_date=start_date, end_date=end_date) }}" class="btn btn-success">
                        <i class="fas fa-file-excel me-2"></i>Export Dataset
                    </a>
                    {% else %}
                    <button type="button" class="btn btn-secondary" disabled title="Admin privileges required">
                        <i class="fas fa-lock me-2"></i>Export Disabled (Admin Only)
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card text-center p-3">
                <i class="fas fa-users fa-2x mb-2"></i>
                <h3 class="mb-1">{{ patient_data_list|length }}</h3>
                <p class="mb-0">Total Patients</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card text-center p-3">
                <i class="fas fa-file-medical fa-2x mb-2"></i>
                <h3 class="mb-1">{{ ordered_fields|length }}</h3>
                <p class="mb-0">Data Fields</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card text-center p-3">
                <i class="fas fa-calendar-alt fa-2x mb-2"></i>
                <h3 class="mb-1">{{ start_date if start_date else 'All' }}</h3>
                <p class="mb-0">Start Date</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card text-center p-3">
                <i class="fas fa-calendar-check fa-2x mb-2"></i>
                <h3 class="mb-1">{{ end_date if end_date else 'All' }}</h3>
                <p class="mb-0">End Date</p>
            </div>
        </div>
    </div>

    <!-- Search Form -->
    <div class="mb-4">
        <form method="GET" action="{{ url_for('dataset_view') }}" id="searchForm">
            <!-- Hidden fields to preserve existing filters -->
            <input type="hidden" name="project_id" value="{{ selected_project or '' }}">
            <input type="hidden" name="form_id" value="{{ selected_form or '' }}">
            <input type="hidden" name="field_name" value="{{ selected_field or '' }}">
            <input type="hidden" name="field_value" value="{{ selected_value or '' }}">
            <input type="hidden" name="start_date" value="{{ start_date or '' }}">
            <input type="hidden" name="end_date" value="{{ end_date or '' }}">

            <div class="input-group">
                <input type="search" class="form-control" placeholder="Search patient ID or any data value..."
                       name="search" value="{{ search_term or '' }}" aria-label="Search dataset">
                <button class="btn btn-outline-primary" type="submit">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
        </form>
    </div>

    <!-- Filter Modal -->
    <div class="modal fade" id="filterModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-filter me-2"></i>Filter Dataset</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="GET" action="{{ url_for('dataset_view') }}" id="filterForm">
                     <!-- Preserve search term -->
                     <input type="hidden" name="search" value="{{ search_term or '' }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="projectFilter" class="form-label">Programme</label>
                            <select class="form-select" id="projectFilter" name="project_id">
                                <option value="">All Programmes</option>
                                {% for project in projects %}
                                <option value="{{ project.id }}" {% if selected_project == project.id %}selected{% endif %}>
                                    {{ project.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="fieldFilter" class="form-label">Form Field</label>
                            <select class="form-select" id="fieldFilter" name="field_name">
                                <option value="">-- Select Field to Filter By --</option>
                                {% for field_label in all_fields_for_filter %}
                                <option value="{{ field_label }}" {% if selected_field == field_label %}selected{% endif %}>
                                    {{ field_label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="valueFilter" class="form-label">Field Value</label>
                            <input type="text" class="form-control" list="fieldValuesList" id="valueFilter" name="field_value" placeholder="Enter exact value to filter" value="{{ selected_value }}">
                            <datalist id="fieldValuesList">
                                {% for value in field_values %}
                                <option value="{{ value }}">
                                {% endfor %}
                            </datalist>
                        </div>
                        <div class="mb-3">
                            <label for="dateRange" class="form-label">Patient Creation Date Range</label>
                            <div class="input-group">
                                <input type="date" class="form-control" name="start_date" value="{{ start_date }}">
                                <span class="input-group-text">to</span>
                                <input type="date" class="form-control" name="end_date" value="{{ end_date }}">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <a href="{{ url_for('dataset_view') }}" class="btn btn-outline-secondary me-auto">Clear Filters</a>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Apply Filters</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Display currently active filters -->
    {# This section is removed as requested #}
    {# <div class="mb-3 d-flex flex-wrap gap-2 align-items-center"> ... </div> #}

    <!-- Dataset Table -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                {% if patient_data_list %}
                <table class="table table-hover table-striped mb-0" id="datasetTable" style="table-layout: fixed;">
                    <thead>
                        <tr>
                            <th style="width: 150px;">Patient ID</th>
                            {% for field_label in ordered_fields %}
                            <th style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ field_label }}</th>
                            {% endfor %}
                            <th style="width: 120px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for patient_row in patient_data_list %}
                        <tr>
                            <td>{{ patient_row.patient_id }}</td>
                            {% for field_label in ordered_fields %}
                            <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="{{ patient_row.get(field_label, '') }}">
                                {{ patient_row.get(field_label, '') }}
                            </td>
                            {% endfor %}
                            <td>
                                <button type="button" class="btn btn-sm btn-info" onclick="viewPatientData('{{ patient_row.patient_id }}')">
                                    <i class="fas fa-eye me-1"></i>Details
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                 <div class="text-center p-5">
                    <i class="fas fa-table fa-3x text-muted mb-3"></i>
                    <h4>No Patient Data Found</h4>
                    <p class="text-muted">No patient records match the current filters. Try adjusting the filters or clearing them.</p>
                    <a href="{{ url_for('dataset_view') }}" class="btn btn-primary mt-2">Clear Filters</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Patient Detail Modal (Placeholder - needs JS implementation) -->
<div class="modal fade" id="patientDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Patient Details (<span id="modalPatientId"></span>)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="patientDetailBody">
                <p class="text-center">Loading patient data...</p>
                 <!-- Data will be loaded here by JS -->
            </div>
            <div class="modal-footer">
                {% if current_user.is_admin %}
                <button type="button" class="btn btn-danger me-auto" id="deletePatientBtn">
                    <i class="fas fa-trash-alt me-1"></i>Delete Patient
                </button>
                {% endif %}
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Function to fetch and display patient details in modal
    function viewPatientData(patientId) {
        const modalTitle = document.getElementById('modalPatientId');
        const modalBody = document.getElementById('patientDetailBody');
        const patientDetailModal = new bootstrap.Modal(document.getElementById('patientDetailModal'));
        const deleteBtn = document.getElementById('deletePatientBtn');

        modalTitle.textContent = patientId;
        modalBody.innerHTML = '<p class="text-center"><span class="spinner-border spinner-border-sm"></span> Loading...</p>';
        patientDetailModal.show();

        // Set up delete button handler
        if (deleteBtn) {
            deleteBtn.onclick = function() {
                confirmDeletePatient(patientId);
            };
        }

        fetch(`/api/patient/${patientId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    modalBody.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                } else {
                    let content = '<dl class="row">';
                    
                    // Handle the new ordered array format
                    data.forEach(item => {
                        const fieldName = item.field;
                        let fieldValue = item.value;
                        
                        // Format the value - remove quotes from strings
                        if (typeof fieldValue === 'string') {
                            // Display as is, without quotes
                            content += `<dt class="col-sm-4">${fieldName}</dt><dd class="col-sm-8">${fieldValue}</dd>`;
                        } else {
                            // For non-string values (objects, arrays, etc.), use JSON.stringify
                            content += `<dt class="col-sm-4">${fieldName}</dt><dd class="col-sm-8">${JSON.stringify(fieldValue)}</dd>`;
                        }
                    });
                    
                    content += '</dl>';
                    modalBody.innerHTML = content;
                }
            })
            .catch(error => {
                console.error('Error fetching patient details:', error);
                modalBody.innerHTML = `<div class="alert alert-danger">Could not load patient details. ${error}</div>`;
            });
    }

    // Function to confirm and handle patient deletion
    function confirmDeletePatient(patientId) {
        if (confirm(`WARNING: You are about to delete patient ${patientId} and ALL associated form submissions. This action cannot be undone. Continue?`)) {
            
            // Show loading indicator
            const modalBody = document.getElementById('patientDetailBody');
            modalBody.innerHTML += '<div class="mt-3 alert alert-warning">Deleting patient data... Please wait.</div>';
            
            // Disable delete button to prevent multiple clicks
            document.getElementById('deletePatientBtn').disabled = true;
            
            // Call the API to delete the patient
            fetch(`/api/patient/${patientId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken() // Function to get CSRF token from cookie
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || `HTTP error! status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // Show success message
                modalBody.innerHTML += `<div class="mt-2 alert alert-success">${data.message || 'Patient deleted successfully'}</div>`;
                
                // Close modal after a delay and refresh the page
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('patientDetailModal')).hide();
                    window.location.reload();
                }, 2000);
            })
            .catch(error => {
                console.error('Error deleting patient:', error);
                modalBody.innerHTML += `<div class="mt-2 alert alert-danger">Error: ${error.message}</div>`;
                document.getElementById('deletePatientBtn').disabled = false;
            });
        }
    }
    
    // Helper function to get CSRF token from cookie
    function getCsrfToken() {
        const name = 'csrf_token=';
        const decodedCookie = decodeURIComponent(document.cookie);
        const cookieArray = decodedCookie.split(';');
        
        for (let i = 0; i < cookieArray.length; i++) {
            let cookie = cookieArray[i].trim();
            if (cookie.indexOf(name) === 0) {
                return cookie.substring(name.length, cookie.length);
            }
        }
        return '';
    }
</script>
{% endblock %}
