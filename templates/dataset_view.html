{% extends "base.html" %}

{% block content %}
<style>
    /* Mobile-specific styles */
    @media (max-width: 767px) {
        .container-fluid {
            padding: 0.75rem !important;
        }
        
        .page-header {
            padding: 1rem !important;
        }
        
        .card-body {
            padding: 0.75rem !important;
        }
        
        /* Make buttons more touch-friendly */
        .btn {
            min-height: 38px;
        }

        /* Fix for modal on small screens */
        .modal-dialog {
            margin: 0.5rem;
        }
        
        /* Improve table scrolling on mobile */
        .table-responsive {
            margin-bottom: 0;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Show horizontal scrolling indicator */
        .table-responsive:after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 40px;
            height: 100%;
            background: linear-gradient(to right, rgba(255,255,255,0), rgba(0,0,0,0.05));
            pointer-events: none;
        }
    }

    /* Pagination improvements */
    .pagination {
        margin-bottom: 0;
    }
    
    .pagination .page-link {
        border-radius: 0.375rem;
        margin: 0 2px;
        border: 1px solid #dee2e6;
        color: #6c757d;
    }
    
    .pagination .page-item.active .page-link {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: white;
    }
    
    .pagination .page-link:hover {
        background-color: #e9ecef;
        border-color: #dee2e6;
        color: #0d6efd;
    }
    
    .pagination .page-item.disabled .page-link {
        color: #6c757d;
        background-color: #fff;
        border-color: #dee2e6;
    }
    
    /* Mobile pagination adjustments */
    @media (max-width: 576px) {
        .pagination-sm .page-link {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        .pagination {
            justify-content: center;
        }
    }
</style>
<div class="container-fluid p-4">
    <!-- Page Header -->
    <div class="page-header mb-3 mb-md-4">
        <div class="row align-items-center">
            <div class="col-12 col-md">
                <h2 class="mb-1 fs-3 fs-md-2"><i class="fas fa-database me-2"></i>Dataset View</h2>
                {% if selected_project_name %}
                    <p class="text-muted mb-2 mb-md-0 small text-md-normal">Viewing data for programme: <strong>{{ selected_project_name }}</strong></p>
                {% elif selected_project %} {# Fallback if name fetch failed but ID exists #}
                     <p class="text-muted mb-2 mb-md-0 small text-md-normal">Viewing data for programme ID: <strong>{{ selected_project }}</strong> (Name fetch error)</p>
                {% else %}
                    <p class="text-muted mb-2 mb-md-0 small text-md-normal">Viewing data for all programmes.</p>
                {% endif %}
            </div>
            <div class="col-12 col-md-auto mt-2 mt-md-0">
                <div class="d-flex flex-wrap gap-2 justify-content-center justify-content-md-end">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#filterModal">
                        <i class="fas fa-filter me-2"></i><span class="d-none d-sm-inline">Filter Data</span>
                    </button>
                    {% if current_user.is_admin %}
                    <a href="{{ url_for('export_dataset', project_id=selected_project, form_id=selected_form, field_name=selected_field, field_value=selected_value, camp_id=selected_camp, start_date=start_date, end_date=end_date, search=search_term) }}" class="btn btn-success" title="Export all {{ total_patients }} patients">
                        <i class="fas fa-file-excel me-2"></i><span class="d-none d-sm-inline">Export Dataset</span>
                    </a>
                    {% else %}
                    <button type="button" class="btn btn-secondary" disabled title="Admin privileges required">
                        <i class="fas fa-lock me-2"></i><span class="d-none d-sm-inline">Export Disabled</span><span class="d-sm-none">Export</span>
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="row mb-4 g-2 g-md-3">
        <div class="col-6 col-md-3">
            <div class="stat-card text-center p-2 p-md-3">
                <i class="fas fa-users fa-2x mb-1 mb-md-2"></i>
                <h3 class="mb-1 fs-5 fs-md-3">{{ total_patients }}</h3>
                <p class="mb-0 small text-md-normal">Total Patients</p>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stat-card text-center p-2 p-md-3">
                <i class="fas fa-file-medical fa-2x mb-1 mb-md-2"></i>
                <h3 class="mb-1 fs-5 fs-md-3">{{ ordered_fields|length }}</h3>
                <p class="mb-0 small text-md-normal">Data Fields</p>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stat-card text-center p-2 p-md-3">
                <i class="fas fa-calendar-alt fa-2x mb-1 mb-md-2"></i>
                <h3 class="mb-1 fs-5 fs-md-3">{{ start_date if start_date else 'All' }}</h3>
                <p class="mb-0 small text-md-normal">Start Date</p>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stat-card text-center p-2 p-md-3">
                <i class="fas fa-calendar-check fa-2x mb-1 mb-md-2"></i>
                <h3 class="mb-1 fs-5 fs-md-3">{{ end_date if end_date else 'All' }}</h3>
                <p class="mb-0 small text-md-normal">End Date</p>
            </div>
        </div>
    </div>

    <!-- Search Form -->
    <div class="mb-3 mb-md-4">
        <form method="GET" action="{{ url_for('dataset_view') }}" id="searchForm">
            <!-- Hidden fields to preserve existing filters -->
            <input type="hidden" name="project_id" value="{{ selected_project or '' }}">
            <input type="hidden" name="form_id" value="{{ selected_form or '' }}">
            <input type="hidden" name="field_name" value="{{ selected_field or '' }}">
            <input type="hidden" name="field_value" value="{{ selected_value or '' }}">
            <input type="hidden" name="camp_id" value="{{ selected_camp or '' }}">
            <input type="hidden" name="start_date" value="{{ start_date or '' }}">
            <input type="hidden" name="end_date" value="{{ end_date or '' }}">
            <input type="hidden" name="page" value="1"> <!-- Reset to page 1 on search -->

            <div class="input-group">
                <input type="search" class="form-control" placeholder="Search patient ID or data..."
                       name="search" value="{{ search_term or '' }}" aria-label="Search dataset">
                <button class="btn btn-outline-primary" type="submit">
                    <i class="fas fa-search"></i><span class="d-none d-md-inline ms-1">Search</span>
                </button>
            </div>
        </form>
    </div>

    <!-- Pagination Info -->
    {% if total_patients > 0 %}
    <div class="mb-3 d-flex justify-content-between align-items-center flex-wrap">
        <div class="mb-2 mb-md-0">
            <small class="text-muted">
                Showing {{ start_index }}-{{ end_index }} of {{ total_patients }} patients
                {% if total_pages > 1 %}(Page {{ current_page }} of {{ total_pages }}){% endif %}
            </small>
        </div>
        <div class="d-flex align-items-center gap-2">
            <small class="text-muted d-none d-md-inline">{{ per_page }} per page</small>
        </div>
    </div>
    {% endif %}

    <!-- Filter Modal -->
    <div class="modal fade" id="filterModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-filter me-2"></i>Filter Dataset</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" title="Close"></button>
                </div>
                <form method="GET" action="{{ url_for('dataset_view') }}" id="filterForm">
                     <!-- Preserve search term and reset to page 1 -->
                     <input type="hidden" name="search" value="{{ search_term or '' }}">
                     <input type="hidden" name="page" value="1">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="projectFilter" class="form-label">Programme</label>
                            <select class="form-select" id="projectFilter" name="project_id" onchange="updateFormDropdown()">
                                <option value="">All Programmes</option>
                                {% for project in projects %}
                                <option value="{{ project.id }}" {% if selected_project == project.id %}selected{% endif %}>
                                    {{ project.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="formFilter" class="form-label">Form</label>
                            <select class="form-select" id="formFilter" name="form_id" onchange="updateFieldDropdown()">
                                <option value="">All Forms</option>
                                {% for form in forms %}
                                <option value="{{ form.id }}" data-project="{{ form.project_id }}" {% if selected_form == form.id %}selected{% endif %} class="form-option">
                                    {{ form.title }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="fieldFilter" class="form-label">Form Field</label>
                            <select class="form-select" id="fieldFilter" name="field_name" onchange="updateFieldValues()">
                                <option value="">-- Select Field to Filter By --</option>
                                {% for field_label in all_fields_for_filter %}
                                <option value="{{ field_label }}" {% if selected_field == field_label %}selected{% endif %} class="field-option">
                                    {{ field_label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="valueFilter" class="form-label">Field Value</label>
                            <input type="text" class="form-control" list="fieldValuesList" id="valueFilter" name="field_value" placeholder="Enter exact value to filter" value="{{ selected_value }}">
                            <datalist id="fieldValuesList">
                                {% for value in field_values %}
                                <option value="{{ value }}">
                                {% endfor %}
                            </datalist>
                        </div>
                        <div class="mb-3">
                            <label for="campFilter" class="form-label">
                                <i class="fas fa-mountain me-1"></i>Camp
                            </label>
                            <select class="form-select" id="campFilter" name="camp_id" onchange="handleCampSelection()">
                                <option value="">Select a Camp...</option>
                                {% for camp in camps %}
                                <option value="{{ camp.id }}" 
                                        data-start="{{ camp.start_date }}" 
                                        data-end="{{ camp.end_date }}"
                                        {% if selected_camp == camp.id %}selected{% endif %}>
                                    {{ camp.name }} ({{ camp.start_date }} to {{ camp.end_date }})
                                </option>
                                {% endfor %}
                            </select>
                            {% if selected_camp_name %}
                            <div class="form-text">
                                Currently filtering by <strong>{{ selected_camp_name }}</strong> dates
                            </div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label for="dateRange" class="form-label">Date Range</label>
                            <div class="input-group">
                                <input type="date" class="form-control" id="startDate" name="start_date" value="{{ start_date if not selected_camp else '' }}" title="Start date" placeholder="Start date">
                                <span class="input-group-text">to</span>
                                <input type="date" class="form-control" id="endDate" name="end_date" value="{{ end_date if not selected_camp else '' }}" title="End date" placeholder="End date">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <a href="{{ url_for('dataset_view') }}" class="btn btn-outline-secondary me-auto">Clear Filters</a>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Apply Filters</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Display currently active filters -->
    {# This section is removed as requested #}
    {# <div class="mb-3 d-flex flex-wrap gap-2 align-items-center"> ... </div> #}

    <!-- Dataset Table -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                {% if patient_data_list %}
                <table class="table table-hover table-striped mb-0" id="datasetTable" style="table-layout: fixed;">
                    <thead>
                        <tr>
                            <th style="width: 150px;">Patient ID</th>
                            {% for field_label in ordered_fields %}
                            <th style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ field_label }}</th>
                            {% endfor %}
                            <th style="width: 120px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for patient_row in patient_data_list %}
                        <tr>
                            <td>{{ patient_row.patient_id }}</td>
                            {% for field_label in ordered_fields %}
                            <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="{{ patient_row.get(field_label, '') }}">
                                {{ patient_row.get(field_label, '') }}
                            </td>
                            {% endfor %}
                            <td>
                                <button type="button" class="btn btn-sm btn-info" onclick="viewPatientData('{{ patient_row.patient_id }}')">
                                    <i class="fas fa-eye me-1"></i><span class="d-none d-md-inline">Details</span>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                 <div class="text-center p-5">
                    <i class="fas fa-table fa-3x text-muted mb-3"></i>
                    <h4>No Patient Data Found</h4>
                    <p class="text-muted">No patient records match the current filters. Try adjusting the filters or clearing them.</p>
                    <a href="{{ url_for('dataset_view') }}" class="btn btn-primary mt-2">Clear Filters</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Pagination Navigation -->
    {% if total_pages > 1 %}
    <div class="d-flex justify-content-center mt-4">
        <nav aria-label="Dataset pagination">
            <ul class="pagination pagination-sm">
                <!-- Previous Page -->
                {% if has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('dataset_view', page=prev_num, project_id=selected_project, form_id=selected_form, field_name=selected_field, field_value=selected_value, camp_id=selected_camp, start_date=start_date, end_date=end_date, search=search_term) }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link" aria-hidden="true">&laquo;</span>
                </li>
                {% endif %}

                <!-- Page Numbers -->
                {% for page_num in page_numbers %}
                {% if page_num == current_page %}
                <li class="page-item active" aria-current="page">
                    <span class="page-link">{{ page_num }}</span>
                </li>
                {% else %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('dataset_view', page=page_num, project_id=selected_project, form_id=selected_form, field_name=selected_field, field_value=selected_value, camp_id=selected_camp, start_date=start_date, end_date=end_date, search=search_term) }}">{{ page_num }}</a>
                </li>
                {% endif %}
                {% endfor %}

                <!-- Next Page -->
                {% if has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('dataset_view', page=next_num, project_id=selected_project, form_id=selected_form, field_name=selected_field, field_value=selected_value, camp_id=selected_camp, start_date=start_date, end_date=end_date, search=search_term) }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link" aria-hidden="true">&raquo;</span>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<!-- Patient Detail Modal (Placeholder - needs JS implementation) -->
<div class="modal fade" id="patientDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Patient Details (<span id="modalPatientId"></span>)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" title="Close"></button>
            </div>
            <div class="modal-body" id="patientDetailBody">
                <p class="text-center">Loading patient data...</p>
                 <!-- Data will be loaded here by JS -->
            </div>
            <div class="modal-footer">
                {% if current_user.is_admin %}
                <button type="button" class="btn btn-danger me-auto" id="deletePatientBtn">
                    <i class="fas fa-trash-alt me-1"></i>Delete Patient
                </button>
                {% endif %}
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Handle camp selection and auto-populate dates
    function handleCampSelection() {
        const campSelect = document.getElementById('campFilter');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        
        if (campSelect.value) {
            // Get selected option
            const selectedOption = campSelect.options[campSelect.selectedIndex];
            const startDate = selectedOption.getAttribute('data-start');
            const endDate = selectedOption.getAttribute('data-end');
            
            // Clear manual date inputs and disable them
            startDateInput.value = '';
            endDateInput.value = '';
            startDateInput.disabled = true;
            endDateInput.disabled = true;
            
            // Add visual indication
            startDateInput.classList.add('bg-light');
            endDateInput.classList.add('bg-light');
            
            console.log('Camp selected:', selectedOption.text, 'Dates:', startDate, 'to', endDate);
        } else {
            // Enable manual date inputs
            startDateInput.disabled = false;
            endDateInput.disabled = false;
            
            // Remove visual indication
            startDateInput.classList.remove('bg-light');
            endDateInput.classList.remove('bg-light');
            
            // Restore original values if they exist
            startDateInput.value = '{{ start_date if not selected_camp else "" }}';
            endDateInput.value = '{{ end_date if not selected_camp else "" }}';
        }
    }

    // Function to fetch and display patient details in modal
    function viewPatientData(patientId) {
        const modalTitle = document.getElementById('modalPatientId');
        const modalBody = document.getElementById('patientDetailBody');
        const patientDetailModal = new bootstrap.Modal(document.getElementById('patientDetailModal'));
        const deleteBtn = document.getElementById('deletePatientBtn');

        modalTitle.textContent = patientId;
        modalBody.innerHTML = '<p class="text-center"><span class="spinner-border spinner-border-sm"></span> Loading...</p>';
        patientDetailModal.show();

        // Set up delete button handler
        if (deleteBtn) {
            deleteBtn.onclick = function() {
                confirmDeletePatient(patientId);
            };
        }

        fetch(`/api/patient/${patientId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    modalBody.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                } else {
                    let content = '<dl class="row">';
                    
                    // Handle the new ordered array format
                    data.forEach(item => {
                        const fieldName = item.field;
                        let fieldValue = item.value;
                        
                        // Format the value - remove quotes from strings
                        if (typeof fieldValue === 'string') {
                            // Display as is, without quotes
                            content += `<dt class="col-sm-4">${fieldName}</dt><dd class="col-sm-8">${fieldValue}</dd>`;
                        } else {
                            // For non-string values (objects, arrays, etc.), use JSON.stringify
                            content += `<dt class="col-sm-4">${fieldName}</dt><dd class="col-sm-8">${JSON.stringify(fieldValue)}</dd>`;
                        }
                    });
                    
                    content += '</dl>';
                    modalBody.innerHTML = content;
                }
            })
            .catch(error => {
                console.error('Error fetching patient details:', error);
                modalBody.innerHTML = `<div class="alert alert-danger">Could not load patient details. ${error}</div>`;
            });
    }

    // Function to confirm and handle patient deletion
    function confirmDeletePatient(patientId) {
        if (confirm(`WARNING: You are about to delete patient ${patientId} and ALL associated form submissions. This action cannot be undone. Continue?`)) {
            
            // Show loading indicator
            const modalBody = document.getElementById('patientDetailBody');
            modalBody.innerHTML += '<div class="mt-3 alert alert-warning">Deleting patient data... Please wait.</div>';
            
            // Disable delete button to prevent multiple clicks
            document.getElementById('deletePatientBtn').disabled = true;
            
            // Call the API to delete the patient
            fetch(`/api/patient/${patientId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken() // Function to get CSRF token from cookie
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || `HTTP error! status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // Show success message
                modalBody.innerHTML += `<div class="mt-2 alert alert-success">${data.message || 'Patient deleted successfully'}</div>`;
                
                // Close modal after a delay and refresh the page
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('patientDetailModal')).hide();
                    window.location.reload();
                }, 2000);
            })
            .catch(error => {
                console.error('Error deleting patient:', error);
                modalBody.innerHTML += `<div class="mt-2 alert alert-danger">Error: ${error.message}</div>`;
                document.getElementById('deletePatientBtn').disabled = false;
            });
        }
    }
    
    // Helper function to get CSRF token from cookie
    function getCsrfToken() {
        const name = 'csrf_token=';
        const decodedCookie = decodeURIComponent(document.cookie);
        const cookieArray = decodedCookie.split(';');
        
        for (let i = 0; i < cookieArray.length; i++) {
            let cookie = cookieArray[i].trim();
            if (cookie.indexOf(name) === 0) {
                return cookie.substring(name.length, cookie.length);
            }
        }
        return '';
    }

    // Function to update the form dropdown based on project selection
    function updateFormDropdown() {
        const projectSelect = document.getElementById('projectFilter');
        const formSelect = document.getElementById('formFilter');
        const selectedProject = projectSelect.value;
        
        // Show all form options initially
        const formOptions = formSelect.querySelectorAll('.form-option');
        
        // If no project is selected, show all forms
        if (!selectedProject) {
            formOptions.forEach(option => {
                option.style.display = 'block';
            });
        } else {
            // Filter forms by selected project
            formOptions.forEach(option => {
                if (option.getAttribute('data-project') === selectedProject) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
        }
        
        // Reset form selection to 'All Forms' (empty value) every time dropdown is updated
        formSelect.value = '';
        
        // After form selection is updated, update the field dropdown
        updateFieldDropdown();
    }
    
    // Function to update the field dropdown based on form selection
    function updateFieldDropdown() {
        const formSelect = document.getElementById('formFilter');
        const fieldSelect = document.getElementById('fieldFilter');
        const selectedForm = formSelect.value;
        
        // Clear current field options except the default option
        const defaultOption = fieldSelect.querySelector('option[value=""]');
        fieldSelect.innerHTML = '';
        if (defaultOption) {
            fieldSelect.appendChild(defaultOption);
        }
        
        // If no form is selected, don't fetch fields
        if (!selectedForm) {
            // Reset field values as well
            document.getElementById('valueFilter').value = '';
            return;
        }
        
        // Show loading indicator in the field dropdown
        const loadingOption = document.createElement('option');
        loadingOption.textContent = 'Loading fields...';
        loadingOption.disabled = true;
        fieldSelect.appendChild(loadingOption);
        
        // Fetch fields for the selected form
        fetch(`/api/form/${selectedForm}/fields`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Remove loading option
                fieldSelect.removeChild(loadingOption);
                
                if (data.error) {
                    const errorOption = document.createElement('option');
                    errorOption.textContent = `Error: ${data.error}`;
                    errorOption.disabled = true;
                    fieldSelect.appendChild(errorOption);
                } else {
                    // Add the fetched fields to the dropdown
                    data.fields.forEach(field => {
                        const option = document.createElement('option');
                        option.value = field;
                        option.textContent = field;
                        option.className = 'field-option';
                        fieldSelect.appendChild(option);
                    });
                    
                    // If there's a previously selected field that still exists in the new options, select it again
                    const currentSelectedField = "{{ selected_field }}";
                    if (currentSelectedField && data.fields.includes(currentSelectedField)) {
                        fieldSelect.value = currentSelectedField;
                    }
                }
                
                // After field dropdown is updated, clear the field value
                document.getElementById('valueFilter').value = '';
            })
            .catch(error => {
                console.error('Error fetching fields:', error);
                
                // Remove loading option
                if (fieldSelect.contains(loadingOption)) {
                    fieldSelect.removeChild(loadingOption);
                }
                
                // Show error message
                const errorOption = document.createElement('option');
                errorOption.textContent = `Failed to load fields: ${error.message}`;
                errorOption.disabled = true;
                fieldSelect.appendChild(errorOption);
            });
    }
    
    // Function to update field values datalist based on selected field
    function updateFieldValues() {
        const formSelect = document.getElementById('formFilter');
        const fieldSelect = document.getElementById('fieldFilter');
        const valueInput = document.getElementById('valueFilter');
        const valuesList = document.getElementById('fieldValuesList');
        
        const selectedForm = formSelect.value;
        const selectedField = fieldSelect.value;
        
        // Clear current field value
        valueInput.value = '';
        
        // Clear current datalist options
        valuesList.innerHTML = '';
        
        // If either form or field is not selected, don't fetch values
        if (!selectedForm || !selectedField) {
            return;
        }
        
        // Encode the field name for URL
        const encodedField = encodeURIComponent(selectedField);
        
        // Fetch possible values for this field
        fetch(`/api/form/${selectedForm}/field/${encodedField}/values`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    console.error('Error fetching field values:', data.error);
                } else {
                    // Add values to datalist
                    data.values.forEach(value => {
                        const option = document.createElement('option');
                        option.value = value;
                        valuesList.appendChild(option);
                    });
                    
                    // If there's a previously selected value, restore it
                    const currentSelectedValue = "{{ selected_value }}";
                    if (currentSelectedValue && data.values.includes(currentSelectedValue)) {
                        valueInput.value = currentSelectedValue;
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching field values:', error);
            });
    }

    // Chrome-friendly approach for fixed columns with horizontal scrolling
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize camp selection
        handleCampSelection();
        
        // Initialize the cascade filtering
        updateFormDropdown();
        
        // Wait a moment for the table to fully render
        setTimeout(function() {
            setupHorizontalScrollWithFixedColumns();
        }, 100);
        
        // Also handle window resize
        window.addEventListener('resize', function() {
            // Remove any existing implementation
            const existingFixedColumns = document.querySelectorAll('.fixed-column-container');
            existingFixedColumns.forEach(el => el.remove());
            
            // Re-setup with new dimensions
            setupHorizontalScrollWithFixedColumns();
        });

        // Add event listener for filter modal show
        var filterModal = document.getElementById('filterModal');
        if (filterModal) {
            filterModal.addEventListener('show.bs.modal', function () {
                var formSelect = document.getElementById('formFilter');
                if (formSelect) {
                    formSelect.value = '';
                }
            });
        }
    });
    
    function setupHorizontalScrollWithFixedColumns() {
        const table = document.getElementById('datasetTable');
        const tableContainer = table.closest('.table-responsive');
        
        if (!table || !tableContainer) return;
        
        // First, modify the table to allow proper horizontal scrolling
        table.style.tableLayout = 'auto';
        tableContainer.style.position = 'relative';
        table.style.width = 'auto';
        table.style.minWidth = '100%';
        
        // Set minimum widths for data columns to prevent compression
        const dataCells = table.querySelectorAll('tr > *:not(:first-child):not(:last-child)');
        dataCells.forEach(cell => {
            cell.style.minWidth = '180px';
        });
        
        // Add a bit of padding to the container to ensure we can see the whole table
        tableContainer.style.paddingBottom = '2px';
        
        // Create container for fixed column (only Patient ID)
        createFixedLeftColumn(table, tableContainer);
        
        // Synchronize scrolling for the left column only
        tableContainer.addEventListener('scroll', function() {
            document.querySelectorAll('.fixed-col-left').forEach(el => {
                el.style.transform = `translateX(${this.scrollLeft}px)`;
            });
        });
    }
    
    function createFixedLeftColumn(table, tableContainer) {
        // Get all table rows
        const tableRows = Array.from(table.rows);
        if (tableRows.length <= 1) return; // Need header + at least one data row
        
        // Copy table styling
        const tableStyle = window.getComputedStyle(table);
        
        // Measure first column width and ensure minimum width to prevent wrapping
        const minColumnWidth = 200; // Increased minimum width to prevent wrapping
        const measuredWidth = tableRows[0].cells[0].offsetWidth;
        const firstColWidth = Math.max(minColumnWidth, measuredWidth);
        
        // Update the original first column width to match
        tableRows.forEach(row => {
            if (row.cells[0]) {
                row.cells[0].style.minWidth = `${firstColWidth}px`;
                row.cells[0].style.width = `${firstColWidth}px`;
            }
        });
        
        // Create left fixed column container
        const leftContainer = document.createElement('div');
        leftContainer.className = 'fixed-column-container fixed-col-left';
        leftContainer.style.position = 'absolute';
        leftContainer.style.left = '0';
        leftContainer.style.top = '0';
        leftContainer.style.zIndex = '10';
        leftContainer.style.width = `${firstColWidth}px`;
        leftContainer.style.height = '100%';
        leftContainer.style.overflow = 'hidden';
        
        // Create clone of original table for fixed column
        const leftTable = document.createElement('table');
        leftTable.className = table.className;
        leftTable.style.tableLayout = 'fixed';
        leftTable.style.width = `${firstColWidth}px`;
        leftTable.style.position = 'absolute';
        leftTable.style.left = '0';
        leftTable.style.top = '0';
        leftTable.style.borderCollapse = tableStyle.borderCollapse;
        leftTable.style.borderSpacing = tableStyle.borderSpacing;
        leftTable.style.margin = '0';
        leftTable.style.fontFamily = tableStyle.fontFamily;
        leftTable.style.fontSize = tableStyle.fontSize;
        leftTable.style.lineHeight = tableStyle.lineHeight;
        
        // Clone rows for fixed first column
        tableRows.forEach((row, rowIndex) => {
            // Get the computed style of the original row
            const rowStyle = window.getComputedStyle(row);
            
            const leftRow = document.createElement('tr');
            leftRow.className = row.className;
            leftRow.style.height = `${row.offsetHeight}px`;
            leftRow.style.borderTop = rowStyle.borderTop;
            leftRow.style.borderBottom = rowStyle.borderBottom;
            
            // Clone first cell for left fixed column
            if (row.cells[0]) {
                const firstCellOriginal = row.cells[0];
                const firstCellStyle = window.getComputedStyle(firstCellOriginal);
                
                const firstCellClone = document.createElement(firstCellOriginal.tagName);
                firstCellClone.innerHTML = firstCellOriginal.innerHTML;
                firstCellClone.className = firstCellOriginal.className;
                
                // Copy all styles exactly
                copyStyles(firstCellOriginal, firstCellClone);
                
                // Override specific styles for fixed column
                firstCellClone.style.width = `${firstColWidth}px`;
                firstCellClone.style.minWidth = `${firstColWidth}px`;
                firstCellClone.style.maxWidth = `${firstColWidth}px`;
                firstCellClone.style.height = `${firstCellOriginal.offsetHeight}px`;
                
                // Ensure background matches - for header row specifically get the correct color from other headers
                if (rowIndex === 0) {
                    // Get color from another header cell that's not the first or last
                    const otherHeaderCell = row.cells[1] || row.cells[0]; // Fallback to first if only one
                    const otherHeaderStyle = window.getComputedStyle(otherHeaderCell);
                    firstCellClone.style.backgroundColor = otherHeaderStyle.backgroundColor;
                } else {
                    firstCellClone.style.backgroundColor = firstCellStyle.backgroundColor;
                }
                
                leftRow.appendChild(firstCellClone);
            }
            
            leftTable.appendChild(leftRow);
        });
        
        // Helper function to copy all computed styles from one element to another
        function copyStyles(source, target) {
            const sourceStyle = window.getComputedStyle(source);
            
            // Copy the most important styles
            target.style.padding = sourceStyle.padding;
            target.style.textAlign = sourceStyle.textAlign;
            target.style.verticalAlign = sourceStyle.verticalAlign;
            target.style.fontWeight = sourceStyle.fontWeight;
            target.style.border = sourceStyle.border;
            target.style.borderTop = sourceStyle.borderTop;
            target.style.borderBottom = sourceStyle.borderBottom;
            target.style.borderLeft = sourceStyle.borderLeft;
            target.style.borderRight = sourceStyle.borderRight;
            target.style.color = sourceStyle.color;
            target.style.fontSize = sourceStyle.fontSize;
            target.style.lineHeight = sourceStyle.lineHeight;
            target.style.fontFamily = sourceStyle.fontFamily;
        }
        
        // Add tables to containers
        leftContainer.appendChild(leftTable);
        
        // Add container to the table container
        tableContainer.appendChild(leftContainer);
        
        // Add shadow for visual separation (more subtle)
        leftContainer.style.boxShadow = '1px 0 3px -1px rgba(0,0,0,0.15)';
        
        // Hover effect synchronization
        addHoverSynchronization(table, leftTable);
    }
    
    function addHoverSynchronization(mainTable, leftTable) {
        // Skip header row, start from index 1
        for (let i = 1; i < mainTable.rows.length; i++) {
            const mainRow = mainTable.rows[i];
            const leftRow = leftTable.rows[i];
            
            if (!mainRow || !leftRow) continue;
            
            // Ensure row heights match exactly
            const rowHeight = mainRow.offsetHeight;
            leftRow.style.height = `${rowHeight}px`;
            
            // Ensure cell heights match exactly
            if (leftRow.cells[0] && mainRow.cells[0]) {
                leftRow.cells[0].style.height = `${mainRow.cells[0].offsetHeight}px`;
            }
            
            // When hovering over main row
            mainRow.addEventListener('mouseenter', function() {
                // Get the actual hover background color from the main table
                const hoverColor = window.getComputedStyle(this).backgroundColor;
                
                if (leftRow) {
                    leftRow.classList.add('table-active');
                    if (leftRow.cells[0]) {
                        leftRow.cells[0].style.backgroundColor = hoverColor;
                    }
                }
            });
            
            mainRow.addEventListener('mouseleave', function() {
                // Get the original background color for the row
                const mainRowIndex = Array.from(mainRow.parentElement.children).indexOf(mainRow);
                const isOdd = mainRowIndex % 2 === 1;
                // Use computed style from original cell to get exact color
                const origBgColor = window.getComputedStyle(mainRow.cells[0]).backgroundColor;
                
                if (leftRow) {
                    leftRow.classList.remove('table-active');
                    if (leftRow.cells[0]) {
                        leftRow.cells[0].style.backgroundColor = origBgColor;
                    }
                }
            });
            
            // When hovering over left fixed column
            if (leftRow) {
                leftRow.addEventListener('mouseenter', function() {
                    // Make main row appear hovered
                    mainRow.dispatchEvent(new Event('mouseenter', {bubbles: true}));
                });
                
                leftRow.addEventListener('mouseleave', function() {
                    // Make main row appear not hovered
                    mainRow.dispatchEvent(new Event('mouseleave', {bubbles: true}));
                });
            }
        }
    }
    
    function makeButtonsInteractive(container) {
        // Find all buttons and make sure they're clickable
        const buttons = container.querySelectorAll('button');
        buttons.forEach(button => {
            button.style.pointerEvents = 'auto';
            container.style.pointerEvents = 'auto';
        });
    }
    
    // Mobile-specific adjustments
    function adjustForMobile() {
        if (window.innerWidth < 768) {
            // Improve touch targets on mobile
            document.querySelectorAll('.btn-sm').forEach(btn => {
                btn.style.padding = '0.375rem 0.5rem';
                btn.style.fontSize = '0.875rem';
            });
            
            // Make sure fixed column is properly shown on mobile
            const fixedColLeft = document.querySelector('.fixed-col-left');
            if (fixedColLeft) {
                fixedColLeft.style.boxShadow = '2px 0 8px -2px rgba(0,0,0,0.2)';
            }
            
            // Ensure our table container has proper padding on mobile
            const tableContainer = document.querySelector('.table-responsive');
            if (tableContainer) {
                tableContainer.style.padding = '0';
            }
        }
    }
    
    // Run on page load and resize
    window.addEventListener('DOMContentLoaded', adjustForMobile);
    window.addEventListener('resize', adjustForMobile);

    // Keyboard navigation for pagination
    document.addEventListener('keydown', function(e) {
        // Only if user is not typing in an input field
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            return;
        }
        
        // Left arrow key - Previous page
        if (e.key === 'ArrowLeft') {
            const prevLink = document.querySelector('.pagination .page-item:not(.disabled) .page-link[aria-label="Previous"]');
            if (prevLink) {
                e.preventDefault();
                window.location.href = prevLink.href;
            }
        }
        
        // Right arrow key - Next page
        if (e.key === 'ArrowRight') {
            const nextLink = document.querySelector('.pagination .page-item:not(.disabled) .page-link[aria-label="Next"]');
            if (nextLink) {
                e.preventDefault();
                window.location.href = nextLink.href;
            }
        }
    });
</script>
{% endblock %}
