{% extends "base.html" %}

{% block content %}
<div class="container-fluid p-4">
    <!-- Page Header -->
    <div class="page-header mb-4">
        <div class="row align-items-center">
            <div class="col">
                <h2 class="mb-1"><i class="fas fa-database me-2"></i>Dataset View</h2>
                {% if selected_project_name %}
                    <p class="text-muted mb-0">Viewing data for programme: <strong>{{ selected_project_name }}</strong></p>
                {% elif selected_project %} {# Fallback if name fetch failed but ID exists #}
                     <p class="text-muted mb-0">Viewing data for programme ID: <strong>{{ selected_project }}</strong> (Name fetch error)</p>
                {% else %}
                    <p class="text-muted mb-0">Viewing data for all programmes.</p>
                {% endif %}
            </div>
            <div class="col-auto">
                <div class="action-buttons">
                    <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#filterModal">
                        <i class="fas fa-filter me-2"></i>Filter Data
                    </button>
                    {% if current_user.is_admin %}
                    <a href="{{ url_for('export_dataset', project_id=selected_project, form_id=selected_form, start_date=start_date, end_date=end_date) }}" class="btn btn-success">
                        <i class="fas fa-file-excel me-2"></i>Export Dataset
                    </a>
                    {% else %}
                    <button type="button" class="btn btn-secondary" disabled title="Admin privileges required">
                        <i class="fas fa-lock me-2"></i>Export Disabled (Admin Only)
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card text-center p-3">
                <i class="fas fa-users fa-2x mb-2"></i>
                <h3 class="mb-1">{{ patient_data_list|length }}</h3>
                <p class="mb-0">Total Patients</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card text-center p-3">
                <i class="fas fa-file-medical fa-2x mb-2"></i>
                <h3 class="mb-1">{{ ordered_fields|length }}</h3>
                <p class="mb-0">Data Fields</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card text-center p-3">
                <i class="fas fa-calendar-alt fa-2x mb-2"></i>
                <h3 class="mb-1">{{ start_date if start_date else 'All' }}</h3>
                <p class="mb-0">Start Date</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card text-center p-3">
                <i class="fas fa-calendar-check fa-2x mb-2"></i>
                <h3 class="mb-1">{{ end_date if end_date else 'All' }}</h3>
                <p class="mb-0">End Date</p>
            </div>
        </div>
    </div>

    <!-- Search Form -->
    <div class="mb-4">
        <form method="GET" action="{{ url_for('dataset_view') }}" id="searchForm">
            <!-- Hidden fields to preserve existing filters -->
            <input type="hidden" name="project_id" value="{{ selected_project or '' }}">
            <input type="hidden" name="form_id" value="{{ selected_form or '' }}">
            <input type="hidden" name="field_name" value="{{ selected_field or '' }}">
            <input type="hidden" name="field_value" value="{{ selected_value or '' }}">
            <input type="hidden" name="start_date" value="{{ start_date or '' }}">
            <input type="hidden" name="end_date" value="{{ end_date or '' }}">

            <div class="input-group">
                <input type="search" class="form-control" placeholder="Search patient ID or any data value..."
                       name="search" value="{{ search_term or '' }}" aria-label="Search dataset">
                <button class="btn btn-outline-primary" type="submit">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
        </form>
    </div>

    <!-- Filter Modal -->
    <div class="modal fade" id="filterModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-filter me-2"></i>Filter Dataset</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="GET" action="{{ url_for('dataset_view') }}" id="filterForm">
                     <!-- Preserve search term -->
                     <input type="hidden" name="search" value="{{ search_term or '' }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="projectFilter" class="form-label">Programme</label>
                            <select class="form-select" id="projectFilter" name="project_id">
                                <option value="">All Programmes</option>
                                {% for project in projects %}
                                <option value="{{ project.id }}" {% if selected_project == project.id %}selected{% endif %}>
                                    {{ project.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="fieldFilter" class="form-label">Form Field</label>
                            <select class="form-select" id="fieldFilter" name="field_name">
                                <option value="">-- Select Field to Filter By --</option>
                                {% for field_label in all_fields_for_filter %}
                                <option value="{{ field_label }}" {% if selected_field == field_label %}selected{% endif %}>
                                    {{ field_label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="valueFilter" class="form-label">Field Value</label>
                            <input type="text" class="form-control" list="fieldValuesList" id="valueFilter" name="field_value" placeholder="Enter exact value to filter" value="{{ selected_value }}">
                            <datalist id="fieldValuesList">
                                {% for value in field_values %}
                                <option value="{{ value }}">
                                {% endfor %}
                            </datalist>
                        </div>
                        <div class="mb-3">
                            <label for="dateRange" class="form-label">Patient Creation Date Range</label>
                            <div class="input-group">
                                <input type="date" class="form-control" name="start_date" value="{{ start_date }}">
                                <span class="input-group-text">to</span>
                                <input type="date" class="form-control" name="end_date" value="{{ end_date }}">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <a href="{{ url_for('dataset_view') }}" class="btn btn-outline-secondary me-auto">Clear Filters</a>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Apply Filters</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Display currently active filters -->
    {# This section is removed as requested #}
    {# <div class="mb-3 d-flex flex-wrap gap-2 align-items-center"> ... </div> #}

    <!-- Dataset Table -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                {% if patient_data_list %}
                <table class="table table-hover table-striped mb-0" id="datasetTable" style="table-layout: fixed;">
                    <thead>
                        <tr>
                            <th style="width: 150px;">Patient ID</th>
                            {% for field_label in ordered_fields %}
                            <th style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ field_label }}</th>
                            {% endfor %}
                            <th style="width: 120px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for patient_row in patient_data_list %}
                        <tr>
                            <td>{{ patient_row.patient_id }}</td>
                            {% for field_label in ordered_fields %}
                            <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="{{ patient_row.get(field_label, '') }}">
                                {{ patient_row.get(field_label, '') }}
                            </td>
                            {% endfor %}
                            <td>
                                <button type="button" class="btn btn-sm btn-info" onclick="viewPatientData('{{ patient_row.patient_id }}')">
                                    <i class="fas fa-eye me-1"></i>Details
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                 <div class="text-center p-5">
                    <i class="fas fa-table fa-3x text-muted mb-3"></i>
                    <h4>No Patient Data Found</h4>
                    <p class="text-muted">No patient records match the current filters. Try adjusting the filters or clearing them.</p>
                    <a href="{{ url_for('dataset_view') }}" class="btn btn-primary mt-2">Clear Filters</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Patient Detail Modal (Placeholder - needs JS implementation) -->
<div class="modal fade" id="patientDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Patient Details (<span id="modalPatientId"></span>)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="patientDetailBody">
                <p class="text-center">Loading patient data...</p>
                 <!-- Data will be loaded here by JS -->
            </div>
            <div class="modal-footer">
                {% if current_user.is_admin %}
                <button type="button" class="btn btn-danger me-auto" id="deletePatientBtn">
                    <i class="fas fa-trash-alt me-1"></i>Delete Patient
                </button>
                {% endif %}
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Function to fetch and display patient details in modal
    function viewPatientData(patientId) {
        const modalTitle = document.getElementById('modalPatientId');
        const modalBody = document.getElementById('patientDetailBody');
        const patientDetailModal = new bootstrap.Modal(document.getElementById('patientDetailModal'));
        const deleteBtn = document.getElementById('deletePatientBtn');

        modalTitle.textContent = patientId;
        modalBody.innerHTML = '<p class="text-center"><span class="spinner-border spinner-border-sm"></span> Loading...</p>';
        patientDetailModal.show();

        // Set up delete button handler
        if (deleteBtn) {
            deleteBtn.onclick = function() {
                confirmDeletePatient(patientId);
            };
        }

        fetch(`/api/patient/${patientId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    modalBody.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                } else {
                    let content = '<dl class="row">';
                    
                    // Handle the new ordered array format
                    data.forEach(item => {
                        const fieldName = item.field;
                        let fieldValue = item.value;
                        
                        // Format the value - remove quotes from strings
                        if (typeof fieldValue === 'string') {
                            // Display as is, without quotes
                            content += `<dt class="col-sm-4">${fieldName}</dt><dd class="col-sm-8">${fieldValue}</dd>`;
                        } else {
                            // For non-string values (objects, arrays, etc.), use JSON.stringify
                            content += `<dt class="col-sm-4">${fieldName}</dt><dd class="col-sm-8">${JSON.stringify(fieldValue)}</dd>`;
                        }
                    });
                    
                    content += '</dl>';
                    modalBody.innerHTML = content;
                }
            })
            .catch(error => {
                console.error('Error fetching patient details:', error);
                modalBody.innerHTML = `<div class="alert alert-danger">Could not load patient details. ${error}</div>`;
            });
    }

    // Function to confirm and handle patient deletion
    function confirmDeletePatient(patientId) {
        if (confirm(`WARNING: You are about to delete patient ${patientId} and ALL associated form submissions. This action cannot be undone. Continue?`)) {
            
            // Show loading indicator
            const modalBody = document.getElementById('patientDetailBody');
            modalBody.innerHTML += '<div class="mt-3 alert alert-warning">Deleting patient data... Please wait.</div>';
            
            // Disable delete button to prevent multiple clicks
            document.getElementById('deletePatientBtn').disabled = true;
            
            // Call the API to delete the patient
            fetch(`/api/patient/${patientId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken() // Function to get CSRF token from cookie
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || `HTTP error! status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // Show success message
                modalBody.innerHTML += `<div class="mt-2 alert alert-success">${data.message || 'Patient deleted successfully'}</div>`;
                
                // Close modal after a delay and refresh the page
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('patientDetailModal')).hide();
                    window.location.reload();
                }, 2000);
            })
            .catch(error => {
                console.error('Error deleting patient:', error);
                modalBody.innerHTML += `<div class="mt-2 alert alert-danger">Error: ${error.message}</div>`;
                document.getElementById('deletePatientBtn').disabled = false;
            });
        }
    }
    
    // Helper function to get CSRF token from cookie
    function getCsrfToken() {
        const name = 'csrf_token=';
        const decodedCookie = decodeURIComponent(document.cookie);
        const cookieArray = decodedCookie.split(';');
        
        for (let i = 0; i < cookieArray.length; i++) {
            let cookie = cookieArray[i].trim();
            if (cookie.indexOf(name) === 0) {
                return cookie.substring(name.length, cookie.length);
            }
        }
        return '';
    }

    // Chrome-friendly approach for fixed columns with horizontal scrolling
    document.addEventListener('DOMContentLoaded', function() {
        // Wait a moment for the table to fully render
        setTimeout(function() {
            setupHorizontalScrollWithFixedColumns();
        }, 100);
        
        // Also handle window resize
        window.addEventListener('resize', function() {
            // Remove any existing implementation
            const existingFixedColumns = document.querySelectorAll('.fixed-column-container');
            existingFixedColumns.forEach(el => el.remove());
            
            // Re-setup with new dimensions
            setupHorizontalScrollWithFixedColumns();
        });
    });
    
    function setupHorizontalScrollWithFixedColumns() {
        const table = document.getElementById('datasetTable');
        const tableContainer = table.closest('.table-responsive');
        
        if (!table || !tableContainer) return;
        
        // First, modify the table to allow proper horizontal scrolling
        table.style.tableLayout = 'auto';
        tableContainer.style.position = 'relative';
        table.style.width = 'auto';
        table.style.minWidth = '100%';
        
        // Set minimum widths for data columns to prevent compression
        const dataCells = table.querySelectorAll('tr > *:not(:first-child):not(:last-child)');
        dataCells.forEach(cell => {
            cell.style.minWidth = '180px';
        });
        
        // Add a bit of padding to the container to ensure we can see the whole table
        tableContainer.style.paddingBottom = '2px';
        
        // Create container for fixed column (only Patient ID)
        createFixedLeftColumn(table, tableContainer);
        
        // Synchronize scrolling for the left column only
        tableContainer.addEventListener('scroll', function() {
            document.querySelectorAll('.fixed-col-left').forEach(el => {
                el.style.transform = `translateX(${this.scrollLeft}px)`;
            });
        });
    }
    
    function createFixedLeftColumn(table, tableContainer) {
        // Get all table rows
        const tableRows = Array.from(table.rows);
        if (tableRows.length <= 1) return; // Need header + at least one data row
        
        // Copy table styling
        const tableStyle = window.getComputedStyle(table);
        
        // Measure first column width and ensure minimum width to prevent wrapping
        const minColumnWidth = 200; // Increased minimum width to prevent wrapping
        const measuredWidth = tableRows[0].cells[0].offsetWidth;
        const firstColWidth = Math.max(minColumnWidth, measuredWidth);
        
        // Update the original first column width to match
        tableRows.forEach(row => {
            if (row.cells[0]) {
                row.cells[0].style.minWidth = `${firstColWidth}px`;
                row.cells[0].style.width = `${firstColWidth}px`;
            }
        });
        
        // Create left fixed column container
        const leftContainer = document.createElement('div');
        leftContainer.className = 'fixed-column-container fixed-col-left';
        leftContainer.style.position = 'absolute';
        leftContainer.style.left = '0';
        leftContainer.style.top = '0';
        leftContainer.style.zIndex = '10';
        leftContainer.style.width = `${firstColWidth}px`;
        leftContainer.style.height = '100%';
        leftContainer.style.overflow = 'hidden';
        
        // Create clone of original table for fixed column
        const leftTable = document.createElement('table');
        leftTable.className = table.className;
        leftTable.style.tableLayout = 'fixed';
        leftTable.style.width = `${firstColWidth}px`;
        leftTable.style.position = 'absolute';
        leftTable.style.left = '0';
        leftTable.style.top = '0';
        leftTable.style.borderCollapse = tableStyle.borderCollapse;
        leftTable.style.borderSpacing = tableStyle.borderSpacing;
        leftTable.style.margin = '0';
        leftTable.style.fontFamily = tableStyle.fontFamily;
        leftTable.style.fontSize = tableStyle.fontSize;
        leftTable.style.lineHeight = tableStyle.lineHeight;
        
        // Clone rows for fixed first column
        tableRows.forEach((row, rowIndex) => {
            // Get the computed style of the original row
            const rowStyle = window.getComputedStyle(row);
            
            const leftRow = document.createElement('tr');
            leftRow.className = row.className;
            leftRow.style.height = `${row.offsetHeight}px`;
            leftRow.style.borderTop = rowStyle.borderTop;
            leftRow.style.borderBottom = rowStyle.borderBottom;
            
            // Clone first cell for left fixed column
            if (row.cells[0]) {
                const firstCellOriginal = row.cells[0];
                const firstCellStyle = window.getComputedStyle(firstCellOriginal);
                
                const firstCellClone = document.createElement(firstCellOriginal.tagName);
                firstCellClone.innerHTML = firstCellOriginal.innerHTML;
                firstCellClone.className = firstCellOriginal.className;
                
                // Copy all styles exactly
                copyStyles(firstCellOriginal, firstCellClone);
                
                // Override specific styles for fixed column
                firstCellClone.style.width = `${firstColWidth}px`;
                firstCellClone.style.minWidth = `${firstColWidth}px`;
                firstCellClone.style.maxWidth = `${firstColWidth}px`;
                firstCellClone.style.height = `${firstCellOriginal.offsetHeight}px`;
                
                // Ensure background matches - for header row specifically get the correct color from other headers
                if (rowIndex === 0) {
                    // Get color from another header cell that's not the first or last
                    const otherHeaderCell = row.cells[1] || row.cells[0]; // Fallback to first if only one
                    const otherHeaderStyle = window.getComputedStyle(otherHeaderCell);
                    firstCellClone.style.backgroundColor = otherHeaderStyle.backgroundColor;
                } else {
                    firstCellClone.style.backgroundColor = firstCellStyle.backgroundColor;
                }
                
                leftRow.appendChild(firstCellClone);
            }
            
            leftTable.appendChild(leftRow);
        });
        
        // Helper function to copy all computed styles from one element to another
        function copyStyles(source, target) {
            const sourceStyle = window.getComputedStyle(source);
            
            // Copy the most important styles
            target.style.padding = sourceStyle.padding;
            target.style.textAlign = sourceStyle.textAlign;
            target.style.verticalAlign = sourceStyle.verticalAlign;
            target.style.fontWeight = sourceStyle.fontWeight;
            target.style.border = sourceStyle.border;
            target.style.borderTop = sourceStyle.borderTop;
            target.style.borderBottom = sourceStyle.borderBottom;
            target.style.borderLeft = sourceStyle.borderLeft;
            target.style.borderRight = sourceStyle.borderRight;
            target.style.color = sourceStyle.color;
            target.style.fontSize = sourceStyle.fontSize;
            target.style.lineHeight = sourceStyle.lineHeight;
            target.style.fontFamily = sourceStyle.fontFamily;
        }
        
        // Add tables to containers
        leftContainer.appendChild(leftTable);
        
        // Add container to the table container
        tableContainer.appendChild(leftContainer);
        
        // Add shadow for visual separation (more subtle)
        leftContainer.style.boxShadow = '1px 0 3px -1px rgba(0,0,0,0.15)';
        
        // Hover effect synchronization
        addHoverSynchronization(table, leftTable);
    }
    
    function addHoverSynchronization(mainTable, leftTable) {
        // Skip header row, start from index 1
        for (let i = 1; i < mainTable.rows.length; i++) {
            const mainRow = mainTable.rows[i];
            const leftRow = leftTable.rows[i];
            
            if (!mainRow || !leftRow) continue;
            
            // Ensure row heights match exactly
            const rowHeight = mainRow.offsetHeight;
            leftRow.style.height = `${rowHeight}px`;
            
            // Ensure cell heights match exactly
            if (leftRow.cells[0] && mainRow.cells[0]) {
                leftRow.cells[0].style.height = `${mainRow.cells[0].offsetHeight}px`;
            }
            
            // When hovering over main row
            mainRow.addEventListener('mouseenter', function() {
                // Get the actual hover background color from the main table
                const hoverColor = window.getComputedStyle(this).backgroundColor;
                
                if (leftRow) {
                    leftRow.classList.add('table-active');
                    if (leftRow.cells[0]) {
                        leftRow.cells[0].style.backgroundColor = hoverColor;
                    }
                }
            });
            
            mainRow.addEventListener('mouseleave', function() {
                // Get the original background color for the row
                const mainRowIndex = Array.from(mainRow.parentElement.children).indexOf(mainRow);
                const isOdd = mainRowIndex % 2 === 1;
                // Use computed style from original cell to get exact color
                const origBgColor = window.getComputedStyle(mainRow.cells[0]).backgroundColor;
                
                if (leftRow) {
                    leftRow.classList.remove('table-active');
                    if (leftRow.cells[0]) {
                        leftRow.cells[0].style.backgroundColor = origBgColor;
                    }
                }
            });
            
            // When hovering over left fixed column
            if (leftRow) {
                leftRow.addEventListener('mouseenter', function() {
                    // Make main row appear hovered
                    mainRow.dispatchEvent(new Event('mouseenter', {bubbles: true}));
                });
                
                leftRow.addEventListener('mouseleave', function() {
                    // Make main row appear not hovered
                    mainRow.dispatchEvent(new Event('mouseleave', {bubbles: true}));
                });
            }
        }
    }
    
    function makeButtonsInteractive(container) {
        // Find all buttons and make sure they're clickable
        const buttons = container.querySelectorAll('button');
        buttons.forEach(button => {
            button.style.pointerEvents = 'auto';
            container.style.pointerEvents = 'auto';
        });
    }
</script>
{% endblock %}
