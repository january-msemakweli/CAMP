import{Server as T}from"@modelcontextprotocol/sdk/server/index.js";import{CallToolRequestSchema as h,ListResourcesRequestSchema as w,ListResourceTemplatesRequestSchema as S,ListToolsRequestSchema as U,ReadResourceRequestSchema as b}from"@modelcontextprotocol/sdk/types.js";import v from"zod-to-json-schema";function f(e){try{return new URL(e),e}catch{throw new Error(`invalid uri: ${e}`)}}function y(e,t){let s=new URL(e),r=new URL(t);return s.href===r.href}function g(e,t){let r=new URL(e).pathname.split("/").slice(1);for(let i of t){let n=new URL(i),l=decodeURIComponent(n.pathname).split("/").slice(1);if(r.length!==l.length)continue;let u={},p=!0;for(let a=0;a<r.length;a++){let o=l[a],c=r[a];if(!o||!c)break;if(o.startsWith("{")&&o.endsWith("}")){let m=o.slice(1,-1);if(!m)break;u[m]=c}else if(r[a]!==l[a]){p=!1;break}}if(p)return{uri:i,params:u}}}function O(e,t){return{uri:e,...t}}function k(e,t){return{uriTemplate:e,...t}}function q(e,t){return{uri:e,mimeType:"application/json",...t}}function j(e,t){return{uriTemplate:e,mimeType:"application/json",...t}}function z(e,t){return t.map(s=>{if("uri"in s){let n=new URL(s.uri,`${e}://`),l=decodeURI(n.href);return{...s,uri:l}}let r=new URL(s.uriTemplate,`${e}://`),i=decodeURI(r.href);return{...s,uriTemplate:i}})}function M(e,t){return{uri:e,mimeType:"application/json",text:JSON.stringify(t)}}function J(e){return e}function I(e){let t={};e.resources&&(t.resources={}),e.tools&&(t.tools={});let s=new T({name:e.name,version:e.version},{capabilities:t});if(s.oninitialized=()=>{let r=s.getClientVersion(),i=s.getClientCapabilities();if(!r)throw new Error("client info not available after initialization");if(!i)throw new Error("client capabilities not available after initialization");e.onInitialize?.(r,i)},e.resources){let r=e.resources,i=r.filter(o=>"uri"in o),n=r.filter(o=>"uriTemplate"in o),l=i.map(({uri:o,name:c,description:m,mimeType:R})=>({uri:o,name:c,description:m,mimeType:R})),u=n.map(({uriTemplate:o,name:c,description:m,mimeType:R})=>({uriTemplate:o,name:c,description:m,mimeType:R})),p=u.map(({uriTemplate:o})=>f(o));async function a(o){let c=i.find(d=>y(d.uri,o));if(c)return await c.read(o);let m=g(o,p);if(!m)throw new Error("resource not found");let R=n.find(d=>d.uriTemplate===m.uri);if(!R)throw new Error("resource not found");return await R.read(o,m.params)}s.setRequestHandler(w,()=>({resources:l})),s.setRequestHandler(S,()=>({resourceTemplates:u})),s.setRequestHandler(b,async o=>{let c=await a(o.params.uri);return{contents:Array.isArray(c)?c:[c]}})}if(e.tools){let r=e.tools,i=Object.entries(r).map(([n,{description:l,parameters:u}])=>({name:n,description:l,inputSchema:v(u)}));s.setRequestHandler(U,async()=>({tools:i})),s.setRequestHandler(h,async n=>{let l=n.params.name;if(!(l in r))throw new Error("tool not found");let u=r[l];if(!u)throw new Error("tool not found");let p=u.parameters.parse(n.params.arguments??{});try{let a=await u.execute(p);return{content:a?[{type:"text",text:JSON.stringify(a)}]:[]}}catch(a){return{isError:!0,content:[{type:"text",text:JSON.stringify({error:E(a)})}]}}})}return s}function E(e){if(!e||typeof e!="object")return e;let t={},s=["name","message"];for(let r of s)r in e&&(t[r]=e[r]);return t}var x=class{#e;#t;ready;readable;writable;onclose;onerror;onmessage;constructor(){let t,s,r=new Promise(n=>{t=n}),i=new Promise(n=>{s=n});this.ready=Promise.all([r,i]).then(()=>{}),this.readable=new ReadableStream({start:n=>{this.#e=n,t()}}),this.writable=new WritableStream({start:n=>{this.#t=n,s()},write:n=>{this.onmessage?.(n)}})}async start(){await this.ready}async send(t){if(!this.#e)throw new Error("readable stream not initialized");this.#e.enqueue(t)}async close(){this.#e?.error(new Error("connection closed")),this.#t?.error(new Error("connection closed")),this.onclose?.()}};export{x as StreamTransport,I as createMcpServer,q as jsonResource,M as jsonResourceResponse,j as jsonResourceTemplate,O as resource,k as resourceTemplate,z as resources,J as tool};
//# sourceMappingURL=index.js.map