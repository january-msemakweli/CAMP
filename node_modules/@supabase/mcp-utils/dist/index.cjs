"use strict";Object.defineProperty(exports, "__esModule", {value: true}); function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; } function _nullishCoalesce(lhs, rhsFn) { if (lhs != null) { return lhs; } else { return rhsFn(); } } function _optionalChain(ops) { let lastAccessLHS = undefined; let value = ops[0]; let i = 1; while (i < ops.length) { const op = ops[i]; const fn = ops[i + 1]; i += 2; if ((op === 'optionalAccess' || op === 'optionalCall') && value == null) { return undefined; } if (op === 'access' || op === 'optionalAccess') { lastAccessLHS = value; value = fn(value); } else if (op === 'call' || op === 'optionalCall') { value = fn((...args) => value.call(lastAccessLHS, ...args)); lastAccessLHS = undefined; } } return value; }var _indexjs = require('@modelcontextprotocol/sdk/server/index.js');var _typesjs = require('@modelcontextprotocol/sdk/types.js');var _zodtojsonschema = require('zod-to-json-schema'); var _zodtojsonschema2 = _interopRequireDefault(_zodtojsonschema);function f(e){try{return new URL(e),e}catch (e2){throw new Error(`invalid uri: ${e}`)}}function y(e,t){let s=new URL(e),r=new URL(t);return s.href===r.href}function g(e,t){let r=new URL(e).pathname.split("/").slice(1);for(let i of t){let n=new URL(i),l=decodeURIComponent(n.pathname).split("/").slice(1);if(r.length!==l.length)continue;let u={},p=!0;for(let a=0;a<r.length;a++){let o=l[a],c=r[a];if(!o||!c)break;if(o.startsWith("{")&&o.endsWith("}")){let m=o.slice(1,-1);if(!m)break;u[m]=c}else if(r[a]!==l[a]){p=!1;break}}if(p)return{uri:i,params:u}}}function O(e,t){return{uri:e,...t}}function k(e,t){return{uriTemplate:e,...t}}function q(e,t){return{uri:e,mimeType:"application/json",...t}}function j(e,t){return{uriTemplate:e,mimeType:"application/json",...t}}function z(e,t){return t.map(s=>{if("uri"in s){let n=new URL(s.uri,`${e}://`),l=decodeURI(n.href);return{...s,uri:l}}let r=new URL(s.uriTemplate,`${e}://`),i=decodeURI(r.href);return{...s,uriTemplate:i}})}function M(e,t){return{uri:e,mimeType:"application/json",text:JSON.stringify(t)}}function J(e){return e}function I(e){let t={};e.resources&&(t.resources={}),e.tools&&(t.tools={});let s=new (0, _indexjs.Server)({name:e.name,version:e.version},{capabilities:t});if(s.oninitialized=()=>{let r=s.getClientVersion(),i=s.getClientCapabilities();if(!r)throw new Error("client info not available after initialization");if(!i)throw new Error("client capabilities not available after initialization");_optionalChain([e, 'access', _ => _.onInitialize, 'optionalCall', _2 => _2(r,i)])},e.resources){let r=e.resources,i=r.filter(o=>"uri"in o),n=r.filter(o=>"uriTemplate"in o),l=i.map(({uri:o,name:c,description:m,mimeType:R})=>({uri:o,name:c,description:m,mimeType:R})),u=n.map(({uriTemplate:o,name:c,description:m,mimeType:R})=>({uriTemplate:o,name:c,description:m,mimeType:R})),p=u.map(({uriTemplate:o})=>f(o));async function a(o){let c=i.find(d=>y(d.uri,o));if(c)return await c.read(o);let m=g(o,p);if(!m)throw new Error("resource not found");let R=n.find(d=>d.uriTemplate===m.uri);if(!R)throw new Error("resource not found");return await R.read(o,m.params)}s.setRequestHandler(_typesjs.ListResourcesRequestSchema,()=>({resources:l})),s.setRequestHandler(_typesjs.ListResourceTemplatesRequestSchema,()=>({resourceTemplates:u})),s.setRequestHandler(_typesjs.ReadResourceRequestSchema,async o=>{let c=await a(o.params.uri);return{contents:Array.isArray(c)?c:[c]}})}if(e.tools){let r=e.tools,i=Object.entries(r).map(([n,{description:l,parameters:u}])=>({name:n,description:l,inputSchema:_zodtojsonschema2.default.call(void 0, u)}));s.setRequestHandler(_typesjs.ListToolsRequestSchema,async()=>({tools:i})),s.setRequestHandler(_typesjs.CallToolRequestSchema,async n=>{let l=n.params.name;if(!(l in r))throw new Error("tool not found");let u=r[l];if(!u)throw new Error("tool not found");let p=u.parameters.parse(_nullishCoalesce(n.params.arguments, () => ({})));try{let a=await u.execute(p);return{content:a?[{type:"text",text:JSON.stringify(a)}]:[]}}catch(a){return{isError:!0,content:[{type:"text",text:JSON.stringify({error:E(a)})}]}}})}return s}function E(e){if(!e||typeof e!="object")return e;let t={},s=["name","message"];for(let r of s)r in e&&(t[r]=e[r]);return t}var x=class{#e;#t;constructor(){let t,s,r=new Promise(n=>{t=n}),i=new Promise(n=>{s=n});this.ready=Promise.all([r,i]).then(()=>{}),this.readable=new ReadableStream({start:n=>{this.#e=n,t()}}),this.writable=new WritableStream({start:n=>{this.#t=n,s()},write:n=>{_optionalChain([this, 'access', _3 => _3.onmessage, 'optionalCall', _4 => _4(n)])}})}async start(){await this.ready}async send(t){if(!this.#e)throw new Error("readable stream not initialized");this.#e.enqueue(t)}async close(){_optionalChain([this, 'access', _5 => _5.#e, 'optionalAccess', _6 => _6.error, 'call', _7 => _7(new Error("connection closed"))]),_optionalChain([this, 'access', _8 => _8.#t, 'optionalAccess', _9 => _9.error, 'call', _10 => _10(new Error("connection closed"))]),_optionalChain([this, 'access', _11 => _11.onclose, 'optionalCall', _12 => _12()])}};exports.StreamTransport = x; exports.createMcpServer = I; exports.jsonResource = q; exports.jsonResourceResponse = M; exports.jsonResourceTemplate = j; exports.resource = O; exports.resourceTemplate = k; exports.resources = z; exports.tool = J;
//# sourceMappingURL=index.cjs.map